"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cdk = require("@aws-cdk/core");
const ec2 = require("@aws-cdk/aws-ec2");
const ecs = require("@aws-cdk/aws-ecs");
const ecr = require("@aws-cdk/aws-ecr");
const aws_iam_1 = require("@aws-cdk/aws-iam");
const sfn = require("@aws-cdk/aws-stepfunctions");
const tasks = require("@aws-cdk/aws-stepfunctions-tasks");
const aws_logs_1 = require("@aws-cdk/aws-logs");
const aws_stepfunctions_1 = require("@aws-cdk/aws-stepfunctions");
const s3 = require("@aws-cdk/aws-s3");
const aws_events_1 = require("@aws-cdk/aws-events");
const lambda = require("@aws-cdk/aws-lambda");
const targets = require("@aws-cdk/aws-events-targets");
const ssm = require("@aws-cdk/aws-ssm");
const STACK_NAME = process.env.STACK_NAME;
const ROLE_NAME = `${STACK_NAME}-fargate-role`;
const VPC_NAME = `${STACK_NAME}-vpc`;
const CIDR_BLOCK = `198.162.0.0/24`;
const MAX_AZs = 2;
const ECR_GATLING_REPO_NAME = `${STACK_NAME}-gatling`;
const ECR_MOCKDATA_REPO_NAME = `${STACK_NAME}-mockdata`;
const ECS_CLUSTER = `${STACK_NAME}-cluster`;
const GATLING_FARGATE_TASK_DEF = `${STACK_NAME}-gatling-task-def`;
const MOCKDATA_FARGATE_TASK_DEF = `${STACK_NAME}-mockdata-task-def`;
const MEMORY_LIMIT = 2048;
const CPU = 1024;
const GATLING_CONTAINER_NAME = `${STACK_NAME}-gatling-container`;
const MOCKDATA_CONTAINER_NAME = `${STACK_NAME}-mockdata-container`;
const STATE_MACHINE_NAME = `loadtest-${STACK_NAME}`;
const S3_BUCKET_NAME = `${STACK_NAME}-loadtest`;
const BRANCH_NAME = process.env.AWS_BRANCH;
class PerftestStackAirlineStack extends cdk.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        // retrieving all environment variables
        const AWS_DEFAULT_REGION = process.env.AWS_DEFAULT_REGION;
        const COGNITO_USER_POOL_ARN = process.env.COGNITO_USER_POOL_ARN || "not_defined";
        const USER_POOL_ID = process.env.USER_POOL_ID || "not_defined";
        const COGNITO_CLIENT_ID = process.env.COGNITO_CLIENT_ID || "not_defined";
        const COGNITO_URL = `https://cognito-idp.${AWS_DEFAULT_REGION}.amazonaws.com/`;
        const GRAPHQL_URL = process.env.GRAPHQL_URL || "not_defined";
        const API_URL = process.env.API_URL || "not_defined";
        const GRAPHQL_API_ID = process.env.GRAPHQL_API_ID || "not_defined";
        const role = new aws_iam_1.Role(this, ROLE_NAME, {
            roleName: ROLE_NAME,
            assumedBy: new aws_iam_1.ServicePrincipal('ecs-tasks.amazonaws.com')
        });
        const bucket = new s3.Bucket(this, "s3bucket", {
            bucketName: S3_BUCKET_NAME
        });
        role.addToPolicy(new aws_iam_1.PolicyStatement({
            resources: [
                `${bucket.bucketArn}`,
                `${bucket.bucketArn}/*`
            ],
            actions: [
                's3:PutObject',
                's3:GetObjectAcl',
                's3:GetObject',
                's3:ListBucket',
                's3:PutObjectAcl',
                's3:DeleteObject'
            ]
        }));
        role.addToPolicy(new aws_iam_1.PolicyStatement({
            resources: [`${COGNITO_USER_POOL_ARN}`],
            actions: [
                'cognito-idp:AdminInitiateAuth',
                'cognito-idp:AdminCreateUser',
                'cognito-idp:AdminSetUserPassword',
                'cognito-idp:UpdateUserPoolClient',
                'cognito-idp:AdminDeleteUser'
            ]
        }));
        const vpc = new ec2.Vpc(this, VPC_NAME, {
            cidr: CIDR_BLOCK,
            maxAzs: MAX_AZs
        });
        const gatlingRepository = new ecr.Repository(this, ECR_GATLING_REPO_NAME, {
            repositoryName: ECR_GATLING_REPO_NAME
        });
        const mockDataRepository = new ecr.Repository(this, ECR_MOCKDATA_REPO_NAME, {
            repositoryName: ECR_MOCKDATA_REPO_NAME
        });
        const cluster = new ecs.Cluster(this, ECS_CLUSTER, {
            vpc: vpc,
            clusterName: ECS_CLUSTER
        });
        const gatlingTaskDefinition = new ecs.FargateTaskDefinition(this, GATLING_FARGATE_TASK_DEF, {
            family: GATLING_FARGATE_TASK_DEF,
            executionRole: role,
            taskRole: role,
            memoryLimitMiB: MEMORY_LIMIT,
            cpu: CPU
        });
        const mockDataTaskDefinition = new ecs.FargateTaskDefinition(this, MOCKDATA_FARGATE_TASK_DEF, {
            family: MOCKDATA_FARGATE_TASK_DEF,
            executionRole: role,
            taskRole: role,
            memoryLimitMiB: MEMORY_LIMIT,
            cpu: CPU
        });
        const gatlingLogging = new ecs.AwsLogDriver({
            logGroup: new aws_logs_1.LogGroup(this, GATLING_CONTAINER_NAME, {
                logGroupName: `/aws/ecs/${GATLING_CONTAINER_NAME}`,
                retention: aws_logs_1.RetentionDays.ONE_WEEK
            }),
            streamPrefix: "gatling"
        });
        const mockDatalogging = new ecs.AwsLogDriver({
            logGroup: new aws_logs_1.LogGroup(this, MOCKDATA_CONTAINER_NAME, {
                logGroupName: `/aws/ecs/${MOCKDATA_CONTAINER_NAME}`,
                retention: aws_logs_1.RetentionDays.ONE_WEEK
            }),
            streamPrefix: "mockdata"
        });
        // Create container from local `Dockerfile` for Gatling
        const gatlingAppContainer = gatlingTaskDefinition.addContainer(GATLING_CONTAINER_NAME, {
            image: ecs.ContainerImage.fromEcrRepository(gatlingRepository),
            logging: gatlingLogging
        });
        const mockDataAppContainer = mockDataTaskDefinition.addContainer(MOCKDATA_CONTAINER_NAME, {
            image: ecs.ContainerImage.fromEcrRepository(mockDataRepository),
            logging: mockDatalogging
        });
        // Step function for setting the load test
        const setupUsers = new sfn.Task(this, "Setup Users", {
            task: new tasks.RunEcsFargateTask({
                cluster,
                taskDefinition: mockDataTaskDefinition,
                assignPublicIp: true,
                containerOverrides: [{
                        containerName: mockDataAppContainer.containerName,
                        command: aws_stepfunctions_1.Data.listAt('$.commands'),
                        environment: [
                            {
                                name: 'setup-users',
                                value: aws_stepfunctions_1.Context.taskToken
                            }
                        ]
                    }],
                integrationPattern: aws_stepfunctions_1.ServiceIntegrationPattern.WAIT_FOR_TASK_TOKEN
            })
        });
        const loadFlights = new sfn.Task(this, "Load Flights", {
            task: new tasks.RunEcsFargateTask({
                cluster,
                taskDefinition: mockDataTaskDefinition,
                assignPublicIp: true,
                containerOverrides: [{
                        containerName: mockDataAppContainer.containerName,
                        command: aws_stepfunctions_1.Data.listAt('$.commands'),
                        environment: [
                            {
                                name: 'load-flights',
                                value: aws_stepfunctions_1.Context.taskToken
                            }
                        ]
                    }],
                integrationPattern: aws_stepfunctions_1.ServiceIntegrationPattern.WAIT_FOR_TASK_TOKEN
            })
        });
        const runGatling = new sfn.Task(this, "Run Gatling", {
            task: new tasks.RunEcsFargateTask({
                cluster,
                taskDefinition: gatlingTaskDefinition,
                assignPublicIp: true,
                containerOverrides: [{
                        containerName: gatlingAppContainer.containerName,
                        command: aws_stepfunctions_1.Data.listAt('$.commands'),
                        environment: [
                            {
                                name: 'run-gatling',
                                value: aws_stepfunctions_1.Context.taskToken
                            }
                        ]
                    }],
                integrationPattern: aws_stepfunctions_1.ServiceIntegrationPattern.WAIT_FOR_TASK_TOKEN
            })
        });
        const consolidateReport = new sfn.Task(this, "Consolidate Report", {
            task: new tasks.RunEcsFargateTask({
                cluster,
                taskDefinition: gatlingTaskDefinition,
                assignPublicIp: true,
                containerOverrides: [{
                        containerName: gatlingAppContainer.containerName,
                        command: aws_stepfunctions_1.Data.listAt('$.commands'),
                        environment: [
                            {
                                name: 'consolidate-report',
                                value: aws_stepfunctions_1.Context.taskToken
                            }
                        ]
                    }],
                integrationPattern: aws_stepfunctions_1.ServiceIntegrationPattern.WAIT_FOR_TASK_TOKEN
            })
        });
        const cleanUp = new sfn.Task(this, "Clean Up", {
            task: new tasks.RunEcsFargateTask({
                cluster,
                taskDefinition: mockDataTaskDefinition,
                assignPublicIp: true,
                containerOverrides: [{
                        containerName: mockDataAppContainer.containerName,
                        command: aws_stepfunctions_1.Data.listAt('$.commands'),
                        environment: [
                            {
                                name: 'clean-up',
                                value: aws_stepfunctions_1.Context.taskToken
                            }
                        ]
                    }],
                integrationPattern: aws_stepfunctions_1.ServiceIntegrationPattern.WAIT_FOR_TASK_TOKEN
            })
        });
        const stepfuncDefinition = setupUsers
            .next(loadFlights)
            .next(runGatling)
            .next(consolidateReport)
            .next(cleanUp);
        const loadtestsfn = new sfn.StateMachine(this, STATE_MACHINE_NAME, {
            stateMachineName: STATE_MACHINE_NAME,
            definition: stepfuncDefinition
        });
        const ecsLambda = new lambda.Function(this, "ecstasklambda", {
            runtime: lambda.Runtime.NODEJS_10_X,
            handler: "index.handler",
            code: new lambda.AssetCode("lambda"),
            functionName: `${STACK_NAME}-ecs-task-change`
        });
        ecsLambda.addToRolePolicy(new aws_iam_1.PolicyStatement({
            actions: ["states:SendTaskSuccess"],
            resources: [loadtestsfn.stateMachineArn]
        }));
        const cwRule = new aws_events_1.Rule(this, "cw-rule", {
            description: "Rule that looks at ECS Task change state and triggers Lambda function",
            enabled: true,
            ruleName: "ECS-task-change-cdk",
            targets: []
        });
        new ssm.StringParameter(this, 'LoadTestS3Bucket', {
            // description: 'Some user-friendly description',
            parameterName: `${BRANCH_NAME}/service/loadtest/s3/bucket`,
            stringValue: bucket.bucketName,
        });
        cwRule.addEventPattern({
            source: ['aws.ecs'],
            detailType: ["ECS Task State Change"],
            detail: {
                clusterArn: [cluster.clusterArn],
                lastStatus: ["STOPPED"]
            }
        });
        cwRule.addTarget(new targets.LambdaFunction(ecsLambda));
        new cdk.CfnOutput(this, "COGNITO_CLIENT_ID", {
            value: COGNITO_CLIENT_ID
        });
        new cdk.CfnOutput(this, "COGNITO_URL", {
            value: COGNITO_URL
        });
        new cdk.CfnOutput(this, "GRAPHQL_URL", {
            value: GRAPHQL_URL
        });
        new cdk.CfnOutput(this, "API_URL", {
            value: API_URL
        });
        new cdk.CfnOutput(this, 'S3_BUCKET', {
            value: bucket.bucketName
        });
        new cdk.CfnOutput(this, "USER_POOL_ID", {
            value: USER_POOL_ID
        });
        new cdk.CfnOutput(this, "APPSYNC_API_KEY", {
            value: GRAPHQL_API_ID,
        });
    }
}
exports.PerftestStackAirlineStack = PerftestStackAirlineStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVyZnRlc3Qtc3RhY2stYWlybGluZS1zdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInBlcmZ0ZXN0LXN0YWNrLWFpcmxpbmUtc3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxxQ0FBc0M7QUFDdEMsd0NBQXdDO0FBQ3hDLHdDQUF3QztBQUN4Qyx3Q0FBd0M7QUFDeEMsOENBQTJFO0FBQzNFLGtEQUFtRDtBQUNuRCwwREFBMkQ7QUFDM0QsZ0RBQTREO0FBQzVELGtFQUFzRjtBQUN0RixzQ0FBdUM7QUFDdkMsb0RBQTJDO0FBQzNDLDhDQUE4QztBQUM5Qyx1REFBdUQ7QUFDdkQsd0NBQXlDO0FBRXpDLE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDO0FBQzFDLE1BQU0sU0FBUyxHQUFHLEdBQUcsVUFBVSxlQUFlLENBQUM7QUFDL0MsTUFBTSxRQUFRLEdBQUcsR0FBRyxVQUFVLE1BQU0sQ0FBQztBQUNyQyxNQUFNLFVBQVUsR0FBRyxnQkFBZ0IsQ0FBQztBQUNwQyxNQUFNLE9BQU8sR0FBRyxDQUFDLENBQUE7QUFDakIsTUFBTSxxQkFBcUIsR0FBRyxHQUFHLFVBQVUsVUFBVSxDQUFBO0FBQ3JELE1BQU0sc0JBQXNCLEdBQUcsR0FBRyxVQUFVLFdBQVcsQ0FBQTtBQUN2RCxNQUFNLFdBQVcsR0FBRyxHQUFHLFVBQVUsVUFBVSxDQUFBO0FBQzNDLE1BQU0sd0JBQXdCLEdBQUcsR0FBRyxVQUFVLG1CQUFtQixDQUFBO0FBQ2pFLE1BQU0seUJBQXlCLEdBQUcsR0FBRyxVQUFVLG9CQUFvQixDQUFBO0FBQ25FLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQTtBQUN6QixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUE7QUFDaEIsTUFBTSxzQkFBc0IsR0FBRyxHQUFHLFVBQVUsb0JBQW9CLENBQUE7QUFDaEUsTUFBTSx1QkFBdUIsR0FBRyxHQUFHLFVBQVUscUJBQXFCLENBQUE7QUFDbEUsTUFBTSxrQkFBa0IsR0FBRyxZQUFZLFVBQVUsRUFBRSxDQUFBO0FBQ25ELE1BQU0sY0FBYyxHQUFHLEdBQUcsVUFBVSxXQUFXLENBQUE7QUFDL0MsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUE7QUFFMUMsTUFBYSx5QkFBMEIsU0FBUSxHQUFHLENBQUMsS0FBSztJQUN0RCxZQUFZLEtBQWMsRUFBRSxFQUFVLEVBQUUsS0FBc0I7UUFDNUQsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFeEIsdUNBQXVDO1FBQ3ZDLE1BQU0sa0JBQWtCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQTtRQUN6RCxNQUFNLHFCQUFxQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMscUJBQXFCLElBQUksYUFBYSxDQUFBO1FBQ2hGLE1BQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxJQUFJLGFBQWEsQ0FBQTtRQUM5RCxNQUFNLGlCQUFpQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLElBQUksYUFBYSxDQUFBO1FBQ3hFLE1BQU0sV0FBVyxHQUFFLHVCQUF1QixrQkFBa0IsaUJBQWlCLENBQUE7UUFDN0UsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLElBQUksYUFBYSxDQUFBO1FBQzVELE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxJQUFJLGFBQWEsQ0FBQTtRQUNwRCxNQUFNLGNBQWMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsSUFBSSxhQUFhLENBQUE7UUFFbEUsTUFBTSxJQUFJLEdBQUcsSUFBSSxjQUFJLENBQUMsSUFBSSxFQUFFLFNBQVMsRUFBRTtZQUNyQyxRQUFRLEVBQUUsU0FBUztZQUNuQixTQUFTLEVBQUUsSUFBSSwwQkFBZ0IsQ0FBQyx5QkFBeUIsQ0FBQztTQUMzRCxDQUFDLENBQUE7UUFFRixNQUFNLE1BQU0sR0FBRyxJQUFJLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLFVBQVUsRUFBRTtZQUM3QyxVQUFVLEVBQUUsY0FBYztTQUMzQixDQUFDLENBQUE7UUFFRixJQUFJLENBQUMsV0FBVyxDQUFDLElBQUkseUJBQWUsQ0FBQztZQUNuQyxTQUFTLEVBQUU7Z0JBQ1QsR0FBRyxNQUFNLENBQUMsU0FBUyxFQUFFO2dCQUNyQixHQUFHLE1BQU0sQ0FBQyxTQUFTLElBQUk7YUFDeEI7WUFDRCxPQUFPLEVBQUU7Z0JBQ1AsY0FBYztnQkFDZCxpQkFBaUI7Z0JBQ2pCLGNBQWM7Z0JBQ2QsZUFBZTtnQkFDZixpQkFBaUI7Z0JBQ2pCLGlCQUFpQjthQUNsQjtTQUNGLENBQUMsQ0FBQyxDQUFBO1FBRUgsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLHlCQUFlLENBQUM7WUFDbkMsU0FBUyxFQUFFLENBQUMsR0FBRyxxQkFBcUIsRUFBRSxDQUFDO1lBQ3ZDLE9BQU8sRUFBRTtnQkFDUCwrQkFBK0I7Z0JBQy9CLDZCQUE2QjtnQkFDN0Isa0NBQWtDO2dCQUNsQyxrQ0FBa0M7Z0JBQ2xDLDZCQUE2QjthQUM5QjtTQUNGLENBQUMsQ0FBQyxDQUFBO1FBRUgsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUU7WUFDdEMsSUFBSSxFQUFFLFVBQVU7WUFDaEIsTUFBTSxFQUFFLE9BQU87U0FDaEIsQ0FBQyxDQUFBO1FBR0YsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLEdBQUcsQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLHFCQUFxQixFQUFFO1lBQ3hFLGNBQWMsRUFBRSxxQkFBcUI7U0FDdEMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxrQkFBa0IsR0FBRyxJQUFJLEdBQUcsQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLHNCQUFzQixFQUFFO1lBQzFFLGNBQWMsRUFBRSxzQkFBc0I7U0FDdkMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxPQUFPLEdBQUcsSUFBSSxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxXQUFXLEVBQUU7WUFDakQsR0FBRyxFQUFFLEdBQUc7WUFDUixXQUFXLEVBQUUsV0FBVztTQUN6QixDQUFDLENBQUM7UUFFSCxNQUFNLHFCQUFxQixHQUFHLElBQUksR0FBRyxDQUFDLHFCQUFxQixDQUFDLElBQUksRUFBRSx3QkFBd0IsRUFBRTtZQUMxRixNQUFNLEVBQUUsd0JBQXdCO1lBQ2hDLGFBQWEsRUFBRSxJQUFJO1lBQ25CLFFBQVEsRUFBRSxJQUFJO1lBQ2QsY0FBYyxFQUFFLFlBQVk7WUFDNUIsR0FBRyxFQUFFLEdBQUc7U0FDVCxDQUFDLENBQUM7UUFFSCxNQUFNLHNCQUFzQixHQUFHLElBQUksR0FBRyxDQUFDLHFCQUFxQixDQUFDLElBQUksRUFBRSx5QkFBeUIsRUFBRTtZQUM1RixNQUFNLEVBQUUseUJBQXlCO1lBQ2pDLGFBQWEsRUFBRSxJQUFJO1lBQ25CLFFBQVEsRUFBRSxJQUFJO1lBQ2QsY0FBYyxFQUFFLFlBQVk7WUFDNUIsR0FBRyxFQUFFLEdBQUc7U0FDVCxDQUFDLENBQUM7UUFFSCxNQUFNLGNBQWMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxZQUFZLENBQUM7WUFDMUMsUUFBUSxFQUFFLElBQUksbUJBQVEsQ0FBQyxJQUFJLEVBQUUsc0JBQXNCLEVBQUU7Z0JBQ25ELFlBQVksRUFBRSxZQUFZLHNCQUFzQixFQUFFO2dCQUNsRCxTQUFTLEVBQUUsd0JBQWEsQ0FBQyxRQUFRO2FBQ2xDLENBQUM7WUFDRixZQUFZLEVBQUUsU0FBUztTQUN4QixDQUFDLENBQUE7UUFFRixNQUFNLGVBQWUsR0FBRyxJQUFJLEdBQUcsQ0FBQyxZQUFZLENBQUM7WUFDM0MsUUFBUSxFQUFFLElBQUksbUJBQVEsQ0FBQyxJQUFJLEVBQUUsdUJBQXVCLEVBQUU7Z0JBQ3BELFlBQVksRUFBRSxZQUFZLHVCQUF1QixFQUFFO2dCQUNuRCxTQUFTLEVBQUUsd0JBQWEsQ0FBQyxRQUFRO2FBQ2xDLENBQUM7WUFDRixZQUFZLEVBQUUsVUFBVTtTQUN6QixDQUFDLENBQUE7UUFFRix1REFBdUQ7UUFDdkQsTUFBTSxtQkFBbUIsR0FBRyxxQkFBcUIsQ0FBQyxZQUFZLENBQUMsc0JBQXNCLEVBQUU7WUFDckYsS0FBSyxFQUFFLEdBQUcsQ0FBQyxjQUFjLENBQUMsaUJBQWlCLENBQUMsaUJBQWlCLENBQUM7WUFDOUQsT0FBTyxFQUFFLGNBQWM7U0FDeEIsQ0FBQyxDQUFDO1FBRUgsTUFBTSxvQkFBb0IsR0FBRyxzQkFBc0IsQ0FBQyxZQUFZLENBQUMsdUJBQXVCLEVBQUU7WUFDeEYsS0FBSyxFQUFFLEdBQUcsQ0FBQyxjQUFjLENBQUMsaUJBQWlCLENBQUMsa0JBQWtCLENBQUM7WUFDL0QsT0FBTyxFQUFFLGVBQWU7U0FDekIsQ0FBQyxDQUFDO1FBRUgsMENBQTBDO1FBQzFDLE1BQU0sVUFBVSxHQUFHLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsYUFBYSxFQUFFO1lBQ25ELElBQUksRUFBRSxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQztnQkFDaEMsT0FBTztnQkFDUCxjQUFjLEVBQUUsc0JBQXNCO2dCQUN0QyxjQUFjLEVBQUUsSUFBSTtnQkFDcEIsa0JBQWtCLEVBQUUsQ0FBQzt3QkFDbkIsYUFBYSxFQUFFLG9CQUFvQixDQUFDLGFBQWE7d0JBQ2pELE9BQU8sRUFBRSx3QkFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUM7d0JBQ2xDLFdBQVcsRUFBRTs0QkFDWDtnQ0FDRSxJQUFJLEVBQUUsYUFBYTtnQ0FDbkIsS0FBSyxFQUFFLDJCQUFPLENBQUMsU0FBUzs2QkFDekI7eUJBQ0Y7cUJBQ0YsQ0FBQztnQkFDRixrQkFBa0IsRUFBRSw2Q0FBeUIsQ0FBQyxtQkFBbUI7YUFDbEUsQ0FBQztTQUNILENBQUMsQ0FBQTtRQUVGLE1BQU0sV0FBVyxHQUFHLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsY0FBYyxFQUFFO1lBQ3JELElBQUksRUFBRSxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQztnQkFDaEMsT0FBTztnQkFDUCxjQUFjLEVBQUUsc0JBQXNCO2dCQUN0QyxjQUFjLEVBQUUsSUFBSTtnQkFDcEIsa0JBQWtCLEVBQUUsQ0FBQzt3QkFDbkIsYUFBYSxFQUFFLG9CQUFvQixDQUFDLGFBQWE7d0JBQ2pELE9BQU8sRUFBRSx3QkFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUM7d0JBQ2xDLFdBQVcsRUFBRTs0QkFDWDtnQ0FDRSxJQUFJLEVBQUUsY0FBYztnQ0FDcEIsS0FBSyxFQUFFLDJCQUFPLENBQUMsU0FBUzs2QkFDekI7eUJBQ0Y7cUJBQ0YsQ0FBQztnQkFDRixrQkFBa0IsRUFBRSw2Q0FBeUIsQ0FBQyxtQkFBbUI7YUFDbEUsQ0FBQztTQUNILENBQUMsQ0FBQTtRQUVGLE1BQU0sVUFBVSxHQUFHLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsYUFBYSxFQUFFO1lBQ25ELElBQUksRUFBRSxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQztnQkFDaEMsT0FBTztnQkFDUCxjQUFjLEVBQUUscUJBQXFCO2dCQUNyQyxjQUFjLEVBQUUsSUFBSTtnQkFDcEIsa0JBQWtCLEVBQUUsQ0FBQzt3QkFDbkIsYUFBYSxFQUFFLG1CQUFtQixDQUFDLGFBQWE7d0JBQ2hELE9BQU8sRUFBRSx3QkFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUM7d0JBQ2xDLFdBQVcsRUFBRTs0QkFDWDtnQ0FDRSxJQUFJLEVBQUUsYUFBYTtnQ0FDbkIsS0FBSyxFQUFFLDJCQUFPLENBQUMsU0FBUzs2QkFDekI7eUJBQ0Y7cUJBQ0YsQ0FBQztnQkFDRixrQkFBa0IsRUFBRSw2Q0FBeUIsQ0FBQyxtQkFBbUI7YUFDbEUsQ0FBQztTQUNILENBQUMsQ0FBQTtRQUVGLE1BQU0saUJBQWlCLEdBQUcsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxvQkFBb0IsRUFBRTtZQUNqRSxJQUFJLEVBQUUsSUFBSSxLQUFLLENBQUMsaUJBQWlCLENBQUM7Z0JBQ2hDLE9BQU87Z0JBQ1AsY0FBYyxFQUFFLHFCQUFxQjtnQkFDckMsY0FBYyxFQUFFLElBQUk7Z0JBQ3BCLGtCQUFrQixFQUFFLENBQUM7d0JBQ25CLGFBQWEsRUFBRSxtQkFBbUIsQ0FBQyxhQUFhO3dCQUNoRCxPQUFPLEVBQUUsd0JBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDO3dCQUNsQyxXQUFXLEVBQUU7NEJBQ1g7Z0NBQ0UsSUFBSSxFQUFFLG9CQUFvQjtnQ0FDMUIsS0FBSyxFQUFFLDJCQUFPLENBQUMsU0FBUzs2QkFDekI7eUJBQ0Y7cUJBQ0YsQ0FBQztnQkFDRixrQkFBa0IsRUFBRSw2Q0FBeUIsQ0FBQyxtQkFBbUI7YUFDbEUsQ0FBQztTQUNILENBQUMsQ0FBQTtRQUVGLE1BQU0sT0FBTyxHQUFHLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsVUFBVSxFQUFFO1lBQzdDLElBQUksRUFBRSxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQztnQkFDaEMsT0FBTztnQkFDUCxjQUFjLEVBQUUsc0JBQXNCO2dCQUN0QyxjQUFjLEVBQUUsSUFBSTtnQkFDcEIsa0JBQWtCLEVBQUUsQ0FBQzt3QkFDbkIsYUFBYSxFQUFFLG9CQUFvQixDQUFDLGFBQWE7d0JBQ2pELE9BQU8sRUFBRSx3QkFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUM7d0JBQ2xDLFdBQVcsRUFBRTs0QkFDWDtnQ0FDRSxJQUFJLEVBQUUsVUFBVTtnQ0FDaEIsS0FBSyxFQUFFLDJCQUFPLENBQUMsU0FBUzs2QkFDekI7eUJBQ0Y7cUJBQ0YsQ0FBQztnQkFDRixrQkFBa0IsRUFBRSw2Q0FBeUIsQ0FBQyxtQkFBbUI7YUFDbEUsQ0FBQztTQUNILENBQUMsQ0FBQTtRQUVGLE1BQU0sa0JBQWtCLEdBQUcsVUFBVTthQUNsQyxJQUFJLENBQUMsV0FBVyxDQUFDO2FBQ2pCLElBQUksQ0FBQyxVQUFVLENBQUM7YUFDaEIsSUFBSSxDQUFDLGlCQUFpQixDQUFDO2FBQ3ZCLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUVoQixNQUFNLFdBQVcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLGtCQUFrQixFQUFFO1lBQ2pFLGdCQUFnQixFQUFFLGtCQUFrQjtZQUNwQyxVQUFVLEVBQUUsa0JBQWtCO1NBQy9CLENBQUMsQ0FBQTtRQUVGLE1BQU0sU0FBUyxHQUFHLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsZUFBZSxFQUFFO1lBQzNELE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVc7WUFDbkMsT0FBTyxFQUFFLGVBQWU7WUFDeEIsSUFBSSxFQUFFLElBQUksTUFBTSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUM7WUFDcEMsWUFBWSxFQUFFLEdBQUcsVUFBVSxrQkFBa0I7U0FDOUMsQ0FBQyxDQUFBO1FBRUYsU0FBUyxDQUFDLGVBQWUsQ0FBQyxJQUFJLHlCQUFlLENBQUM7WUFDNUMsT0FBTyxFQUFFLENBQUMsd0JBQXdCLENBQUM7WUFDbkMsU0FBUyxFQUFFLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQztTQUN6QyxDQUFDLENBQUMsQ0FBQTtRQUVILE1BQU0sTUFBTSxHQUFHLElBQUksaUJBQUksQ0FBQyxJQUFJLEVBQUUsU0FBUyxFQUFFO1lBQ3ZDLFdBQVcsRUFBRSx1RUFBdUU7WUFDcEYsT0FBTyxFQUFFLElBQUk7WUFDYixRQUFRLEVBQUUscUJBQXFCO1lBQy9CLE9BQU8sRUFBRSxFQUNSO1NBQ0YsQ0FBQyxDQUFBO1FBRUYsSUFBSSxHQUFHLENBQUMsZUFBZSxDQUFDLElBQUksRUFBRSxrQkFBa0IsRUFBRTtZQUNoRCxpREFBaUQ7WUFDakQsYUFBYSxFQUFFLEdBQUcsV0FBVyw2QkFBNkI7WUFDMUQsV0FBVyxFQUFFLE1BQU0sQ0FBQyxVQUFVO1NBRS9CLENBQUMsQ0FBQztRQUVILE1BQU0sQ0FBQyxlQUFlLENBQUM7WUFDckIsTUFBTSxFQUFFLENBQUMsU0FBUyxDQUFDO1lBQ25CLFVBQVUsRUFBRSxDQUFDLHVCQUF1QixDQUFDO1lBQ3JDLE1BQU0sRUFBRTtnQkFDTixVQUFVLEVBQUUsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDO2dCQUNoQyxVQUFVLEVBQUUsQ0FBQyxTQUFTLENBQUM7YUFDeEI7U0FDRixDQUFDLENBQUE7UUFFRixNQUFNLENBQUMsU0FBUyxDQUFDLElBQUksT0FBTyxDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFBO1FBRXZELElBQUksR0FBRyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsbUJBQW1CLEVBQUU7WUFDM0MsS0FBSyxFQUFFLGlCQUFpQjtTQUN6QixDQUFDLENBQUE7UUFFRixJQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLGFBQWEsRUFBRTtZQUNyQyxLQUFLLEVBQUUsV0FBVztTQUNuQixDQUFDLENBQUE7UUFFRixJQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLGFBQWEsRUFBRTtZQUNyQyxLQUFLLEVBQUUsV0FBVztTQUNuQixDQUFDLENBQUE7UUFFRixJQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLFNBQVMsRUFBRTtZQUNqQyxLQUFLLEVBQUUsT0FBTztTQUNmLENBQUMsQ0FBQTtRQUVGLElBQUksR0FBRyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsV0FBVyxFQUFFO1lBQ25DLEtBQUssRUFBRSxNQUFNLENBQUMsVUFBVTtTQUN6QixDQUFDLENBQUE7UUFFRixJQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLGNBQWMsRUFBRTtZQUN0QyxLQUFLLEVBQUUsWUFBWTtTQUNwQixDQUFDLENBQUE7UUFFRixJQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLGlCQUFpQixFQUFFO1lBQ3pDLEtBQUssRUFBRSxjQUFjO1NBQ3RCLENBQUMsQ0FBQTtJQUdKLENBQUM7Q0FDRjtBQTlSRCw4REE4UkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2RrID0gcmVxdWlyZSgnQGF3cy1jZGsvY29yZScpO1xuaW1wb3J0IGVjMiA9IHJlcXVpcmUoJ0Bhd3MtY2RrL2F3cy1lYzInKVxuaW1wb3J0IGVjcyA9IHJlcXVpcmUoJ0Bhd3MtY2RrL2F3cy1lY3MnKVxuaW1wb3J0IGVjciA9IHJlcXVpcmUoJ0Bhd3MtY2RrL2F3cy1lY3InKVxuaW1wb3J0IHsgUm9sZSwgU2VydmljZVByaW5jaXBhbCwgUG9saWN5U3RhdGVtZW50IH0gZnJvbSAnQGF3cy1jZGsvYXdzLWlhbSc7XG5pbXBvcnQgc2ZuID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLXN0ZXBmdW5jdGlvbnMnKTtcbmltcG9ydCB0YXNrcyA9IHJlcXVpcmUoJ0Bhd3MtY2RrL2F3cy1zdGVwZnVuY3Rpb25zLXRhc2tzJyk7XG5pbXBvcnQgeyBMb2dHcm91cCwgUmV0ZW50aW9uRGF5cyB9IGZyb20gJ0Bhd3MtY2RrL2F3cy1sb2dzJztcbmltcG9ydCB7IERhdGEsIFNlcnZpY2VJbnRlZ3JhdGlvblBhdHRlcm4sIENvbnRleHQgfSBmcm9tICdAYXdzLWNkay9hd3Mtc3RlcGZ1bmN0aW9ucyc7XG5pbXBvcnQgczMgPSByZXF1aXJlKCdAYXdzLWNkay9hd3MtczMnKTtcbmltcG9ydCB7IFJ1bGUgfSBmcm9tICdAYXdzLWNkay9hd3MtZXZlbnRzJztcbmltcG9ydCBsYW1iZGEgPSByZXF1aXJlKCdAYXdzLWNkay9hd3MtbGFtYmRhJylcbmltcG9ydCB0YXJnZXRzID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLWV2ZW50cy10YXJnZXRzJylcbmltcG9ydCBzc20gPSByZXF1aXJlKCdAYXdzLWNkay9hd3Mtc3NtJyk7XG5cbmNvbnN0IFNUQUNLX05BTUUgPSBwcm9jZXNzLmVudi5TVEFDS19OQU1FO1xuY29uc3QgUk9MRV9OQU1FID0gYCR7U1RBQ0tfTkFNRX0tZmFyZ2F0ZS1yb2xlYDtcbmNvbnN0IFZQQ19OQU1FID0gYCR7U1RBQ0tfTkFNRX0tdnBjYDtcbmNvbnN0IENJRFJfQkxPQ0sgPSBgMTk4LjE2Mi4wLjAvMjRgO1xuY29uc3QgTUFYX0FacyA9IDJcbmNvbnN0IEVDUl9HQVRMSU5HX1JFUE9fTkFNRSA9IGAke1NUQUNLX05BTUV9LWdhdGxpbmdgXG5jb25zdCBFQ1JfTU9DS0RBVEFfUkVQT19OQU1FID0gYCR7U1RBQ0tfTkFNRX0tbW9ja2RhdGFgXG5jb25zdCBFQ1NfQ0xVU1RFUiA9IGAke1NUQUNLX05BTUV9LWNsdXN0ZXJgXG5jb25zdCBHQVRMSU5HX0ZBUkdBVEVfVEFTS19ERUYgPSBgJHtTVEFDS19OQU1FfS1nYXRsaW5nLXRhc2stZGVmYFxuY29uc3QgTU9DS0RBVEFfRkFSR0FURV9UQVNLX0RFRiA9IGAke1NUQUNLX05BTUV9LW1vY2tkYXRhLXRhc2stZGVmYFxuY29uc3QgTUVNT1JZX0xJTUlUID0gMjA0OFxuY29uc3QgQ1BVID0gMTAyNFxuY29uc3QgR0FUTElOR19DT05UQUlORVJfTkFNRSA9IGAke1NUQUNLX05BTUV9LWdhdGxpbmctY29udGFpbmVyYFxuY29uc3QgTU9DS0RBVEFfQ09OVEFJTkVSX05BTUUgPSBgJHtTVEFDS19OQU1FfS1tb2NrZGF0YS1jb250YWluZXJgXG5jb25zdCBTVEFURV9NQUNISU5FX05BTUUgPSBgbG9hZHRlc3QtJHtTVEFDS19OQU1FfWBcbmNvbnN0IFMzX0JVQ0tFVF9OQU1FID0gYCR7U1RBQ0tfTkFNRX0tbG9hZHRlc3RgXG5jb25zdCBCUkFOQ0hfTkFNRSA9IHByb2Nlc3MuZW52LkFXU19CUkFOQ0hcblxuZXhwb3J0IGNsYXNzIFBlcmZ0ZXN0U3RhY2tBaXJsaW5lU3RhY2sgZXh0ZW5kcyBjZGsuU3RhY2sge1xuICBjb25zdHJ1Y3RvcihzY29wZTogY2RrLkFwcCwgaWQ6IHN0cmluZywgcHJvcHM/OiBjZGsuU3RhY2tQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpO1xuXG4gICAgLy8gcmV0cmlldmluZyBhbGwgZW52aXJvbm1lbnQgdmFyaWFibGVzXG4gICAgY29uc3QgQVdTX0RFRkFVTFRfUkVHSU9OID0gcHJvY2Vzcy5lbnYuQVdTX0RFRkFVTFRfUkVHSU9OXG4gICAgY29uc3QgQ09HTklUT19VU0VSX1BPT0xfQVJOID0gcHJvY2Vzcy5lbnYuQ09HTklUT19VU0VSX1BPT0xfQVJOIHx8IFwibm90X2RlZmluZWRcIlxuICAgIGNvbnN0IFVTRVJfUE9PTF9JRCA9IHByb2Nlc3MuZW52LlVTRVJfUE9PTF9JRCB8fCBcIm5vdF9kZWZpbmVkXCJcbiAgICBjb25zdCBDT0dOSVRPX0NMSUVOVF9JRCA9IHByb2Nlc3MuZW52LkNPR05JVE9fQ0xJRU5UX0lEIHx8IFwibm90X2RlZmluZWRcIlxuICAgIGNvbnN0IENPR05JVE9fVVJMPSBgaHR0cHM6Ly9jb2duaXRvLWlkcC4ke0FXU19ERUZBVUxUX1JFR0lPTn0uYW1hem9uYXdzLmNvbS9gXG4gICAgY29uc3QgR1JBUEhRTF9VUkwgPSBwcm9jZXNzLmVudi5HUkFQSFFMX1VSTCB8fCBcIm5vdF9kZWZpbmVkXCJcbiAgICBjb25zdCBBUElfVVJMID0gcHJvY2Vzcy5lbnYuQVBJX1VSTCB8fCBcIm5vdF9kZWZpbmVkXCJcbiAgICBjb25zdCBHUkFQSFFMX0FQSV9JRCA9IHByb2Nlc3MuZW52LkdSQVBIUUxfQVBJX0lEIHx8IFwibm90X2RlZmluZWRcIlxuXG4gICAgY29uc3Qgcm9sZSA9IG5ldyBSb2xlKHRoaXMsIFJPTEVfTkFNRSwge1xuICAgICAgcm9sZU5hbWU6IFJPTEVfTkFNRSxcbiAgICAgIGFzc3VtZWRCeTogbmV3IFNlcnZpY2VQcmluY2lwYWwoJ2Vjcy10YXNrcy5hbWF6b25hd3MuY29tJylcbiAgICB9KVxuXG4gICAgY29uc3QgYnVja2V0ID0gbmV3IHMzLkJ1Y2tldCh0aGlzLCBcInMzYnVja2V0XCIsIHtcbiAgICAgIGJ1Y2tldE5hbWU6IFMzX0JVQ0tFVF9OQU1FXG4gICAgfSlcblxuICAgIHJvbGUuYWRkVG9Qb2xpY3kobmV3IFBvbGljeVN0YXRlbWVudCh7XG4gICAgICByZXNvdXJjZXM6IFtcbiAgICAgICAgYCR7YnVja2V0LmJ1Y2tldEFybn1gLFxuICAgICAgICBgJHtidWNrZXQuYnVja2V0QXJufS8qYFxuICAgICAgXSxcbiAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgJ3MzOlB1dE9iamVjdCcsXG4gICAgICAgICdzMzpHZXRPYmplY3RBY2wnLFxuICAgICAgICAnczM6R2V0T2JqZWN0JyxcbiAgICAgICAgJ3MzOkxpc3RCdWNrZXQnLFxuICAgICAgICAnczM6UHV0T2JqZWN0QWNsJyxcbiAgICAgICAgJ3MzOkRlbGV0ZU9iamVjdCdcbiAgICAgIF1cbiAgICB9KSlcblxuICAgIHJvbGUuYWRkVG9Qb2xpY3kobmV3IFBvbGljeVN0YXRlbWVudCh7XG4gICAgICByZXNvdXJjZXM6IFtgJHtDT0dOSVRPX1VTRVJfUE9PTF9BUk59YF0sXG4gICAgICBhY3Rpb25zOiBbXG4gICAgICAgICdjb2duaXRvLWlkcDpBZG1pbkluaXRpYXRlQXV0aCcsXG4gICAgICAgICdjb2duaXRvLWlkcDpBZG1pbkNyZWF0ZVVzZXInLFxuICAgICAgICAnY29nbml0by1pZHA6QWRtaW5TZXRVc2VyUGFzc3dvcmQnLFxuICAgICAgICAnY29nbml0by1pZHA6VXBkYXRlVXNlclBvb2xDbGllbnQnLFxuICAgICAgICAnY29nbml0by1pZHA6QWRtaW5EZWxldGVVc2VyJ1xuICAgICAgXVxuICAgIH0pKVxuXG4gICAgY29uc3QgdnBjID0gbmV3IGVjMi5WcGModGhpcywgVlBDX05BTUUsIHtcbiAgICAgIGNpZHI6IENJRFJfQkxPQ0ssXG4gICAgICBtYXhBenM6IE1BWF9BWnNcbiAgICB9KVxuXG5cbiAgICBjb25zdCBnYXRsaW5nUmVwb3NpdG9yeSA9IG5ldyBlY3IuUmVwb3NpdG9yeSh0aGlzLCBFQ1JfR0FUTElOR19SRVBPX05BTUUsIHtcbiAgICAgIHJlcG9zaXRvcnlOYW1lOiBFQ1JfR0FUTElOR19SRVBPX05BTUVcbiAgICB9KTtcblxuICAgIGNvbnN0IG1vY2tEYXRhUmVwb3NpdG9yeSA9IG5ldyBlY3IuUmVwb3NpdG9yeSh0aGlzLCBFQ1JfTU9DS0RBVEFfUkVQT19OQU1FLCB7XG4gICAgICByZXBvc2l0b3J5TmFtZTogRUNSX01PQ0tEQVRBX1JFUE9fTkFNRVxuICAgIH0pO1xuXG4gICAgY29uc3QgY2x1c3RlciA9IG5ldyBlY3MuQ2x1c3Rlcih0aGlzLCBFQ1NfQ0xVU1RFUiwge1xuICAgICAgdnBjOiB2cGMsXG4gICAgICBjbHVzdGVyTmFtZTogRUNTX0NMVVNURVJcbiAgICB9KTtcblxuICAgIGNvbnN0IGdhdGxpbmdUYXNrRGVmaW5pdGlvbiA9IG5ldyBlY3MuRmFyZ2F0ZVRhc2tEZWZpbml0aW9uKHRoaXMsIEdBVExJTkdfRkFSR0FURV9UQVNLX0RFRiwge1xuICAgICAgZmFtaWx5OiBHQVRMSU5HX0ZBUkdBVEVfVEFTS19ERUYsXG4gICAgICBleGVjdXRpb25Sb2xlOiByb2xlLFxuICAgICAgdGFza1JvbGU6IHJvbGUsXG4gICAgICBtZW1vcnlMaW1pdE1pQjogTUVNT1JZX0xJTUlULFxuICAgICAgY3B1OiBDUFVcbiAgICB9KTtcblxuICAgIGNvbnN0IG1vY2tEYXRhVGFza0RlZmluaXRpb24gPSBuZXcgZWNzLkZhcmdhdGVUYXNrRGVmaW5pdGlvbih0aGlzLCBNT0NLREFUQV9GQVJHQVRFX1RBU0tfREVGLCB7XG4gICAgICBmYW1pbHk6IE1PQ0tEQVRBX0ZBUkdBVEVfVEFTS19ERUYsXG4gICAgICBleGVjdXRpb25Sb2xlOiByb2xlLFxuICAgICAgdGFza1JvbGU6IHJvbGUsXG4gICAgICBtZW1vcnlMaW1pdE1pQjogTUVNT1JZX0xJTUlULFxuICAgICAgY3B1OiBDUFVcbiAgICB9KTtcblxuICAgIGNvbnN0IGdhdGxpbmdMb2dnaW5nID0gbmV3IGVjcy5Bd3NMb2dEcml2ZXIoe1xuICAgICAgbG9nR3JvdXA6IG5ldyBMb2dHcm91cCh0aGlzLCBHQVRMSU5HX0NPTlRBSU5FUl9OQU1FLCB7XG4gICAgICAgIGxvZ0dyb3VwTmFtZTogYC9hd3MvZWNzLyR7R0FUTElOR19DT05UQUlORVJfTkFNRX1gLFxuICAgICAgICByZXRlbnRpb246IFJldGVudGlvbkRheXMuT05FX1dFRUtcbiAgICAgIH0pLFxuICAgICAgc3RyZWFtUHJlZml4OiBcImdhdGxpbmdcIlxuICAgIH0pXG5cbiAgICBjb25zdCBtb2NrRGF0YWxvZ2dpbmcgPSBuZXcgZWNzLkF3c0xvZ0RyaXZlcih7XG4gICAgICBsb2dHcm91cDogbmV3IExvZ0dyb3VwKHRoaXMsIE1PQ0tEQVRBX0NPTlRBSU5FUl9OQU1FLCB7XG4gICAgICAgIGxvZ0dyb3VwTmFtZTogYC9hd3MvZWNzLyR7TU9DS0RBVEFfQ09OVEFJTkVSX05BTUV9YCxcbiAgICAgICAgcmV0ZW50aW9uOiBSZXRlbnRpb25EYXlzLk9ORV9XRUVLXG4gICAgICB9KSxcbiAgICAgIHN0cmVhbVByZWZpeDogXCJtb2NrZGF0YVwiXG4gICAgfSlcblxuICAgIC8vIENyZWF0ZSBjb250YWluZXIgZnJvbSBsb2NhbCBgRG9ja2VyZmlsZWAgZm9yIEdhdGxpbmdcbiAgICBjb25zdCBnYXRsaW5nQXBwQ29udGFpbmVyID0gZ2F0bGluZ1Rhc2tEZWZpbml0aW9uLmFkZENvbnRhaW5lcihHQVRMSU5HX0NPTlRBSU5FUl9OQU1FLCB7XG4gICAgICBpbWFnZTogZWNzLkNvbnRhaW5lckltYWdlLmZyb21FY3JSZXBvc2l0b3J5KGdhdGxpbmdSZXBvc2l0b3J5KSxcbiAgICAgIGxvZ2dpbmc6IGdhdGxpbmdMb2dnaW5nXG4gICAgfSk7XG5cbiAgICBjb25zdCBtb2NrRGF0YUFwcENvbnRhaW5lciA9IG1vY2tEYXRhVGFza0RlZmluaXRpb24uYWRkQ29udGFpbmVyKE1PQ0tEQVRBX0NPTlRBSU5FUl9OQU1FLCB7XG4gICAgICBpbWFnZTogZWNzLkNvbnRhaW5lckltYWdlLmZyb21FY3JSZXBvc2l0b3J5KG1vY2tEYXRhUmVwb3NpdG9yeSksXG4gICAgICBsb2dnaW5nOiBtb2NrRGF0YWxvZ2dpbmdcbiAgICB9KTtcblxuICAgIC8vIFN0ZXAgZnVuY3Rpb24gZm9yIHNldHRpbmcgdGhlIGxvYWQgdGVzdFxuICAgIGNvbnN0IHNldHVwVXNlcnMgPSBuZXcgc2ZuLlRhc2sodGhpcywgXCJTZXR1cCBVc2Vyc1wiLCB7XG4gICAgICB0YXNrOiBuZXcgdGFza3MuUnVuRWNzRmFyZ2F0ZVRhc2soe1xuICAgICAgICBjbHVzdGVyLFxuICAgICAgICB0YXNrRGVmaW5pdGlvbjogbW9ja0RhdGFUYXNrRGVmaW5pdGlvbixcbiAgICAgICAgYXNzaWduUHVibGljSXA6IHRydWUsXG4gICAgICAgIGNvbnRhaW5lck92ZXJyaWRlczogW3tcbiAgICAgICAgICBjb250YWluZXJOYW1lOiBtb2NrRGF0YUFwcENvbnRhaW5lci5jb250YWluZXJOYW1lLFxuICAgICAgICAgIGNvbW1hbmQ6IERhdGEubGlzdEF0KCckLmNvbW1hbmRzJyksXG4gICAgICAgICAgZW52aXJvbm1lbnQ6IFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgbmFtZTogJ3NldHVwLXVzZXJzJyxcbiAgICAgICAgICAgICAgdmFsdWU6IENvbnRleHQudGFza1Rva2VuXG4gICAgICAgICAgICB9XG4gICAgICAgICAgXVxuICAgICAgICB9XSxcbiAgICAgICAgaW50ZWdyYXRpb25QYXR0ZXJuOiBTZXJ2aWNlSW50ZWdyYXRpb25QYXR0ZXJuLldBSVRfRk9SX1RBU0tfVE9LRU5cbiAgICAgIH0pXG4gICAgfSlcblxuICAgIGNvbnN0IGxvYWRGbGlnaHRzID0gbmV3IHNmbi5UYXNrKHRoaXMsIFwiTG9hZCBGbGlnaHRzXCIsIHtcbiAgICAgIHRhc2s6IG5ldyB0YXNrcy5SdW5FY3NGYXJnYXRlVGFzayh7XG4gICAgICAgIGNsdXN0ZXIsXG4gICAgICAgIHRhc2tEZWZpbml0aW9uOiBtb2NrRGF0YVRhc2tEZWZpbml0aW9uLFxuICAgICAgICBhc3NpZ25QdWJsaWNJcDogdHJ1ZSxcbiAgICAgICAgY29udGFpbmVyT3ZlcnJpZGVzOiBbe1xuICAgICAgICAgIGNvbnRhaW5lck5hbWU6IG1vY2tEYXRhQXBwQ29udGFpbmVyLmNvbnRhaW5lck5hbWUsXG4gICAgICAgICAgY29tbWFuZDogRGF0YS5saXN0QXQoJyQuY29tbWFuZHMnKSxcbiAgICAgICAgICBlbnZpcm9ubWVudDogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBuYW1lOiAnbG9hZC1mbGlnaHRzJyxcbiAgICAgICAgICAgICAgdmFsdWU6IENvbnRleHQudGFza1Rva2VuXG4gICAgICAgICAgICB9XG4gICAgICAgICAgXVxuICAgICAgICB9XSxcbiAgICAgICAgaW50ZWdyYXRpb25QYXR0ZXJuOiBTZXJ2aWNlSW50ZWdyYXRpb25QYXR0ZXJuLldBSVRfRk9SX1RBU0tfVE9LRU5cbiAgICAgIH0pXG4gICAgfSlcblxuICAgIGNvbnN0IHJ1bkdhdGxpbmcgPSBuZXcgc2ZuLlRhc2sodGhpcywgXCJSdW4gR2F0bGluZ1wiLCB7XG4gICAgICB0YXNrOiBuZXcgdGFza3MuUnVuRWNzRmFyZ2F0ZVRhc2soe1xuICAgICAgICBjbHVzdGVyLFxuICAgICAgICB0YXNrRGVmaW5pdGlvbjogZ2F0bGluZ1Rhc2tEZWZpbml0aW9uLFxuICAgICAgICBhc3NpZ25QdWJsaWNJcDogdHJ1ZSxcbiAgICAgICAgY29udGFpbmVyT3ZlcnJpZGVzOiBbe1xuICAgICAgICAgIGNvbnRhaW5lck5hbWU6IGdhdGxpbmdBcHBDb250YWluZXIuY29udGFpbmVyTmFtZSxcbiAgICAgICAgICBjb21tYW5kOiBEYXRhLmxpc3RBdCgnJC5jb21tYW5kcycpLFxuICAgICAgICAgIGVudmlyb25tZW50OiBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIG5hbWU6ICdydW4tZ2F0bGluZycsXG4gICAgICAgICAgICAgIHZhbHVlOiBDb250ZXh0LnRhc2tUb2tlblxuICAgICAgICAgICAgfVxuICAgICAgICAgIF1cbiAgICAgICAgfV0sXG4gICAgICAgIGludGVncmF0aW9uUGF0dGVybjogU2VydmljZUludGVncmF0aW9uUGF0dGVybi5XQUlUX0ZPUl9UQVNLX1RPS0VOXG4gICAgICB9KVxuICAgIH0pXG5cbiAgICBjb25zdCBjb25zb2xpZGF0ZVJlcG9ydCA9IG5ldyBzZm4uVGFzayh0aGlzLCBcIkNvbnNvbGlkYXRlIFJlcG9ydFwiLCB7XG4gICAgICB0YXNrOiBuZXcgdGFza3MuUnVuRWNzRmFyZ2F0ZVRhc2soe1xuICAgICAgICBjbHVzdGVyLFxuICAgICAgICB0YXNrRGVmaW5pdGlvbjogZ2F0bGluZ1Rhc2tEZWZpbml0aW9uLFxuICAgICAgICBhc3NpZ25QdWJsaWNJcDogdHJ1ZSxcbiAgICAgICAgY29udGFpbmVyT3ZlcnJpZGVzOiBbe1xuICAgICAgICAgIGNvbnRhaW5lck5hbWU6IGdhdGxpbmdBcHBDb250YWluZXIuY29udGFpbmVyTmFtZSxcbiAgICAgICAgICBjb21tYW5kOiBEYXRhLmxpc3RBdCgnJC5jb21tYW5kcycpLFxuICAgICAgICAgIGVudmlyb25tZW50OiBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIG5hbWU6ICdjb25zb2xpZGF0ZS1yZXBvcnQnLFxuICAgICAgICAgICAgICB2YWx1ZTogQ29udGV4dC50YXNrVG9rZW5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICBdXG4gICAgICAgIH1dLFxuICAgICAgICBpbnRlZ3JhdGlvblBhdHRlcm46IFNlcnZpY2VJbnRlZ3JhdGlvblBhdHRlcm4uV0FJVF9GT1JfVEFTS19UT0tFTlxuICAgICAgfSlcbiAgICB9KVxuXG4gICAgY29uc3QgY2xlYW5VcCA9IG5ldyBzZm4uVGFzayh0aGlzLCBcIkNsZWFuIFVwXCIsIHtcbiAgICAgIHRhc2s6IG5ldyB0YXNrcy5SdW5FY3NGYXJnYXRlVGFzayh7XG4gICAgICAgIGNsdXN0ZXIsXG4gICAgICAgIHRhc2tEZWZpbml0aW9uOiBtb2NrRGF0YVRhc2tEZWZpbml0aW9uLFxuICAgICAgICBhc3NpZ25QdWJsaWNJcDogdHJ1ZSxcbiAgICAgICAgY29udGFpbmVyT3ZlcnJpZGVzOiBbe1xuICAgICAgICAgIGNvbnRhaW5lck5hbWU6IG1vY2tEYXRhQXBwQ29udGFpbmVyLmNvbnRhaW5lck5hbWUsXG4gICAgICAgICAgY29tbWFuZDogRGF0YS5saXN0QXQoJyQuY29tbWFuZHMnKSxcbiAgICAgICAgICBlbnZpcm9ubWVudDogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBuYW1lOiAnY2xlYW4tdXAnLFxuICAgICAgICAgICAgICB2YWx1ZTogQ29udGV4dC50YXNrVG9rZW5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICBdXG4gICAgICAgIH1dLFxuICAgICAgICBpbnRlZ3JhdGlvblBhdHRlcm46IFNlcnZpY2VJbnRlZ3JhdGlvblBhdHRlcm4uV0FJVF9GT1JfVEFTS19UT0tFTlxuICAgICAgfSlcbiAgICB9KVxuXG4gICAgY29uc3Qgc3RlcGZ1bmNEZWZpbml0aW9uID0gc2V0dXBVc2Vyc1xuICAgICAgLm5leHQobG9hZEZsaWdodHMpXG4gICAgICAubmV4dChydW5HYXRsaW5nKVxuICAgICAgLm5leHQoY29uc29saWRhdGVSZXBvcnQpXG4gICAgICAubmV4dChjbGVhblVwKVxuXG4gICAgY29uc3QgbG9hZHRlc3RzZm4gPSBuZXcgc2ZuLlN0YXRlTWFjaGluZSh0aGlzLCBTVEFURV9NQUNISU5FX05BTUUsIHtcbiAgICAgIHN0YXRlTWFjaGluZU5hbWU6IFNUQVRFX01BQ0hJTkVfTkFNRSxcbiAgICAgIGRlZmluaXRpb246IHN0ZXBmdW5jRGVmaW5pdGlvblxuICAgIH0pXG5cbiAgICBjb25zdCBlY3NMYW1iZGEgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsIFwiZWNzdGFza2xhbWJkYVwiLCB7XG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTBfWCxcbiAgICAgIGhhbmRsZXI6IFwiaW5kZXguaGFuZGxlclwiLFxuICAgICAgY29kZTogbmV3IGxhbWJkYS5Bc3NldENvZGUoXCJsYW1iZGFcIiksXG4gICAgICBmdW5jdGlvbk5hbWU6IGAke1NUQUNLX05BTUV9LWVjcy10YXNrLWNoYW5nZWBcbiAgICB9KVxuXG4gICAgZWNzTGFtYmRhLmFkZFRvUm9sZVBvbGljeShuZXcgUG9saWN5U3RhdGVtZW50KHtcbiAgICAgIGFjdGlvbnM6IFtcInN0YXRlczpTZW5kVGFza1N1Y2Nlc3NcIl0sXG4gICAgICByZXNvdXJjZXM6IFtsb2FkdGVzdHNmbi5zdGF0ZU1hY2hpbmVBcm5dXG4gICAgfSkpXG5cbiAgICBjb25zdCBjd1J1bGUgPSBuZXcgUnVsZSh0aGlzLCBcImN3LXJ1bGVcIiwge1xuICAgICAgZGVzY3JpcHRpb246IFwiUnVsZSB0aGF0IGxvb2tzIGF0IEVDUyBUYXNrIGNoYW5nZSBzdGF0ZSBhbmQgdHJpZ2dlcnMgTGFtYmRhIGZ1bmN0aW9uXCIsXG4gICAgICBlbmFibGVkOiB0cnVlLFxuICAgICAgcnVsZU5hbWU6IFwiRUNTLXRhc2stY2hhbmdlLWNka1wiLFxuICAgICAgdGFyZ2V0czogWyBcbiAgICAgIF1cbiAgICB9KVxuXG4gICAgbmV3IHNzbS5TdHJpbmdQYXJhbWV0ZXIodGhpcywgJ0xvYWRUZXN0UzNCdWNrZXQnLCB7XG4gICAgICAvLyBkZXNjcmlwdGlvbjogJ1NvbWUgdXNlci1mcmllbmRseSBkZXNjcmlwdGlvbicsXG4gICAgICBwYXJhbWV0ZXJOYW1lOiBgJHtCUkFOQ0hfTkFNRX0vc2VydmljZS9sb2FkdGVzdC9zMy9idWNrZXRgLFxuICAgICAgc3RyaW5nVmFsdWU6IGJ1Y2tldC5idWNrZXROYW1lLFxuICAgICAgLy8gYWxsb3dlZFBhdHRlcm46ICcuKicsXG4gICAgfSk7XG5cbiAgICBjd1J1bGUuYWRkRXZlbnRQYXR0ZXJuKHtcbiAgICAgIHNvdXJjZTogWydhd3MuZWNzJ10sXG4gICAgICBkZXRhaWxUeXBlOiBbXCJFQ1MgVGFzayBTdGF0ZSBDaGFuZ2VcIl0sXG4gICAgICBkZXRhaWw6IHtcbiAgICAgICAgY2x1c3RlckFybjogW2NsdXN0ZXIuY2x1c3RlckFybl0sXG4gICAgICAgIGxhc3RTdGF0dXM6IFtcIlNUT1BQRURcIl1cbiAgICAgIH1cbiAgICB9KVxuXG4gICAgY3dSdWxlLmFkZFRhcmdldChuZXcgdGFyZ2V0cy5MYW1iZGFGdW5jdGlvbihlY3NMYW1iZGEpKVxuXG4gICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgXCJDT0dOSVRPX0NMSUVOVF9JRFwiLCB7XG4gICAgICB2YWx1ZTogQ09HTklUT19DTElFTlRfSURcbiAgICB9KVxuXG4gICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgXCJDT0dOSVRPX1VSTFwiLCB7XG4gICAgICB2YWx1ZTogQ09HTklUT19VUkxcbiAgICB9KVxuXG4gICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgXCJHUkFQSFFMX1VSTFwiLCB7XG4gICAgICB2YWx1ZTogR1JBUEhRTF9VUkxcbiAgICB9KVxuXG4gICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgXCJBUElfVVJMXCIsIHtcbiAgICAgIHZhbHVlOiBBUElfVVJMXG4gICAgfSlcblxuICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHRoaXMsICdTM19CVUNLRVQnLCB7XG4gICAgICB2YWx1ZTogYnVja2V0LmJ1Y2tldE5hbWVcbiAgICB9KVxuXG4gICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgXCJVU0VSX1BPT0xfSURcIiwge1xuICAgICAgdmFsdWU6IFVTRVJfUE9PTF9JRFxuICAgIH0pXG5cbiAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCBcIkFQUFNZTkNfQVBJX0tFWVwiLCB7XG4gICAgICB2YWx1ZTogR1JBUEhRTF9BUElfSUQsXG4gICAgfSlcblxuXG4gIH1cbn1cbiJdfQ==