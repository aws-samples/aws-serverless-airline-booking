"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cdk = require("@aws-cdk/core");
const ec2 = require("@aws-cdk/aws-ec2");
const ecs = require("@aws-cdk/aws-ecs");
const ecr = require("@aws-cdk/aws-ecr");
const aws_iam_1 = require("@aws-cdk/aws-iam");
const sfn = require("@aws-cdk/aws-stepfunctions");
const tasks = require("@aws-cdk/aws-stepfunctions-tasks");
const aws_logs_1 = require("@aws-cdk/aws-logs");
const aws_stepfunctions_1 = require("@aws-cdk/aws-stepfunctions");
const s3 = require("@aws-cdk/aws-s3");
const aws_events_1 = require("@aws-cdk/aws-events");
const lambda = require("@aws-cdk/aws-lambda");
const targets = require("@aws-cdk/aws-events-targets");
const ssm = require("@aws-cdk/aws-ssm");
const STACK_NAME = process.env.STACK_NAME;
const ROLE_NAME = `${STACK_NAME}-fargate-role`;
const VPC_NAME = `${STACK_NAME}-vpc`;
const CIDR_BLOCK = `198.162.0.0/24`;
const MAX_AZs = 2;
const ECR_GATLING_REPO_NAME = `${STACK_NAME}-gatling`;
const ECR_MOCKDATA_REPO_NAME = `${STACK_NAME}-mockdata`;
const ECS_CLUSTER = `${STACK_NAME}-cluster`;
const GATLING_FARGATE_TASK_DEF = `${STACK_NAME}-gatling-task-def`;
const MOCKDATA_FARGATE_TASK_DEF = `${STACK_NAME}-mockdata-task-def`;
const MEMORY_LIMIT = 2048;
const CPU = 1024;
const GATLING_CONTAINER_NAME = `${STACK_NAME}-gatling-container`;
const MOCKDATA_CONTAINER_NAME = `${STACK_NAME}-mockdata-container`;
const STATE_MACHINE_NAME = `loadtest-${STACK_NAME}`;
const S3_BUCKET_NAME = `${STACK_NAME}-loadtest`;
const BRANCH_NAME = process.env.AWS_BRANCH;
const FOLDERPATH = "./";
class PerftestStackAirlineStack extends cdk.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        // retrieving all environment variables
        const AWS_DEFAULT_REGION = process.env.AWS_DEFAULT_REGION;
        const COGNITO_USER_POOL_ARN = process.env.COGNITO_USER_POOL_ARN || "not_defined";
        const USER_POOL_ID = process.env.USER_POOL_ID || "not_defined";
        const COGNITO_CLIENT_ID = process.env.COGNITO_CLIENT_ID || "not_defined";
        const COGNITO_URL = `https://cognito-idp.${AWS_DEFAULT_REGION}.amazonaws.com/`;
        const GRAPHQL_URL = process.env.GRAPHQL_URL || "not_defined";
        const API_URL = process.env.API_URL || "not_defined";
        const GRAPHQL_API_ID = process.env.GRAPHQL_API_ID || "not_defined";
        const role = new aws_iam_1.Role(this, ROLE_NAME, {
            roleName: ROLE_NAME,
            assumedBy: new aws_iam_1.ServicePrincipal('ecs-tasks.amazonaws.com')
        });
        const bucket = new s3.Bucket(this, "s3bucket", {
            bucketName: S3_BUCKET_NAME
        });
        role.addToPolicy(new aws_iam_1.PolicyStatement({
            resources: [
                `${bucket.bucketArn}`,
                `${bucket.bucketArn}/*`
            ],
            actions: [
                's3:PutObject',
                's3:GetObjectAcl',
                's3:GetObject',
                's3:ListBucket',
                's3:PutObjectAcl',
                's3:DeleteObject'
            ]
        }));
        role.addToPolicy(new aws_iam_1.PolicyStatement({
            resources: [`${COGNITO_USER_POOL_ARN}`],
            actions: [
                'cognito-idp:AdminInitiateAuth',
                'cognito-idp:AdminCreateUser',
                'cognito-idp:AdminSetUserPassword',
                'cognito-idp:UpdateUserPoolClient',
                'cognito-idp:AdminDeleteUser'
            ]
        }));
        const vpc = new ec2.Vpc(this, VPC_NAME, {
            cidr: CIDR_BLOCK,
            maxAzs: MAX_AZs
        });
        const gatlingRepository = new ecr.Repository(this, ECR_GATLING_REPO_NAME, {
            repositoryName: ECR_GATLING_REPO_NAME
        });
        const mockDataRepository = new ecr.Repository(this, ECR_MOCKDATA_REPO_NAME, {
            repositoryName: ECR_MOCKDATA_REPO_NAME
        });
        const cluster = new ecs.Cluster(this, ECS_CLUSTER, {
            vpc: vpc,
            clusterName: ECS_CLUSTER
        });
        const gatlingTaskDefinition = new ecs.FargateTaskDefinition(this, GATLING_FARGATE_TASK_DEF, {
            family: GATLING_FARGATE_TASK_DEF,
            executionRole: role,
            taskRole: role,
            memoryLimitMiB: MEMORY_LIMIT,
            cpu: CPU
        });
        const mockDataTaskDefinition = new ecs.FargateTaskDefinition(this, MOCKDATA_FARGATE_TASK_DEF, {
            family: MOCKDATA_FARGATE_TASK_DEF,
            executionRole: role,
            taskRole: role,
            memoryLimitMiB: MEMORY_LIMIT,
            cpu: CPU
        });
        const gatlingLogging = new ecs.AwsLogDriver({
            logGroup: new aws_logs_1.LogGroup(this, GATLING_CONTAINER_NAME, {
                logGroupName: `/aws/ecs/${GATLING_CONTAINER_NAME}`,
                retention: aws_logs_1.RetentionDays.ONE_WEEK
            }),
            streamPrefix: "gatling"
        });
        const mockDatalogging = new ecs.AwsLogDriver({
            logGroup: new aws_logs_1.LogGroup(this, MOCKDATA_CONTAINER_NAME, {
                logGroupName: `/aws/ecs/${MOCKDATA_CONTAINER_NAME}`,
                retention: aws_logs_1.RetentionDays.ONE_WEEK
            }),
            streamPrefix: "mockdata"
        });
        // Create container from local `Dockerfile` for Gatling
        const gatlingAppContainer = gatlingTaskDefinition.addContainer(GATLING_CONTAINER_NAME, {
            image: ecs.ContainerImage.fromEcrRepository(gatlingRepository),
            logging: gatlingLogging
        });
        const tokenCSV = ssm.StringParameter.fromStringParameterAttributes(this, 'TOKEN_CSV', {
            parameterName: `/${BRANCH_NAME}/service/loadtest/csv/token`,
            version: 1
        });
        const userCSV = ssm.StringParameter.fromStringParameterAttributes(this, 'USER_CSV', {
            parameterName: `/${BRANCH_NAME}/service/loadtest/csv/user`,
            version: 1
        });
        const loadtestBucket = ssm.StringParameter.fromStringParameterAttributes(this, 'S3_BUCKET', {
            parameterName: `/${BRANCH_NAME}/service/s3/loadtest/bucket`,
            version: 1
        });
        const userPoolID = ssm.StringParameter.fromStringParameterAttributes(this, 'USER_POOL_ID', {
            parameterName: `/${BRANCH_NAME}/service/amplify/auth/userpool/id`,
            version: 1
        });
        const cognitoClientID = ssm.StringParameter.fromStringParameterAttributes(this, 'COGNITO_CLIENT_ID', {
            parameterName: `/${BRANCH_NAME}/service/amplify/auth/userpool/clientId`,
            version: 1
        });
        const mockDataAppContainer = mockDataTaskDefinition.addContainer(MOCKDATA_CONTAINER_NAME, {
            image: ecs.ContainerImage.fromEcrRepository(mockDataRepository),
            logging: mockDatalogging,
            environment: {
                "TOKEN_CSV": tokenCSV.stringValue,
                "USER_CSV": userCSV.stringValue,
                "AWS_REGION": `${AWS_DEFAULT_REGION}`,
                "S3_BUCKET": loadtestBucket.stringValue,
                "USER_POOL_ID": userPoolID.stringValue,
                // "COGNITO_CLIENT_ID": cognitoClientID.stringValue,
                "FOLDERPATH": FOLDERPATH
            }
        });
        // Step function for setting the load test
        const setupUsers = new sfn.Task(this, "Setup Users", {
            task: new tasks.RunEcsFargateTask({
                cluster,
                taskDefinition: mockDataTaskDefinition,
                assignPublicIp: true,
                containerOverrides: [{
                        containerName: mockDataAppContainer.containerName,
                        command: aws_stepfunctions_1.Data.listAt('$.commands'),
                        environment: [
                            {
                                name: 'setup-users',
                                value: aws_stepfunctions_1.Context.taskToken
                            }
                        ]
                    }],
                integrationPattern: aws_stepfunctions_1.ServiceIntegrationPattern.WAIT_FOR_TASK_TOKEN
            })
        });
        const loadFlights = new sfn.Task(this, "Load Flights", {
            task: new tasks.RunEcsFargateTask({
                cluster,
                taskDefinition: mockDataTaskDefinition,
                assignPublicIp: true,
                containerOverrides: [{
                        containerName: mockDataAppContainer.containerName,
                        command: aws_stepfunctions_1.Data.listAt('$.commands'),
                        environment: [
                            {
                                name: 'load-flights',
                                value: aws_stepfunctions_1.Context.taskToken
                            }
                        ]
                    }],
                integrationPattern: aws_stepfunctions_1.ServiceIntegrationPattern.WAIT_FOR_TASK_TOKEN
            })
        });
        const runGatling = new sfn.Task(this, "Run Gatling", {
            task: new tasks.RunEcsFargateTask({
                cluster,
                taskDefinition: gatlingTaskDefinition,
                assignPublicIp: true,
                containerOverrides: [{
                        containerName: gatlingAppContainer.containerName,
                        command: aws_stepfunctions_1.Data.listAt('$.commands'),
                        environment: [
                            {
                                name: 'run-gatling',
                                value: aws_stepfunctions_1.Context.taskToken
                            }
                        ]
                    }],
                integrationPattern: aws_stepfunctions_1.ServiceIntegrationPattern.WAIT_FOR_TASK_TOKEN
            })
        });
        const consolidateReport = new sfn.Task(this, "Consolidate Report", {
            task: new tasks.RunEcsFargateTask({
                cluster,
                taskDefinition: gatlingTaskDefinition,
                assignPublicIp: true,
                containerOverrides: [{
                        containerName: gatlingAppContainer.containerName,
                        command: aws_stepfunctions_1.Data.listAt('$.commands'),
                        environment: [
                            {
                                name: 'consolidate-report',
                                value: aws_stepfunctions_1.Context.taskToken
                            }
                        ]
                    }],
                integrationPattern: aws_stepfunctions_1.ServiceIntegrationPattern.WAIT_FOR_TASK_TOKEN
            })
        });
        const cleanUp = new sfn.Task(this, "Clean Up", {
            task: new tasks.RunEcsFargateTask({
                cluster,
                taskDefinition: mockDataTaskDefinition,
                assignPublicIp: true,
                containerOverrides: [{
                        containerName: mockDataAppContainer.containerName,
                        command: aws_stepfunctions_1.Data.listAt('$.commands'),
                        environment: [
                            {
                                name: 'clean-up',
                                value: aws_stepfunctions_1.Context.taskToken
                            }
                        ]
                    }],
                integrationPattern: aws_stepfunctions_1.ServiceIntegrationPattern.WAIT_FOR_TASK_TOKEN
            })
        });
        const stepfuncDefinition = setupUsers
            .next(loadFlights)
            .next(runGatling)
            .next(consolidateReport)
            .next(cleanUp);
        const loadtestsfn = new sfn.StateMachine(this, STATE_MACHINE_NAME, {
            stateMachineName: STATE_MACHINE_NAME,
            definition: stepfuncDefinition
        });
        const ecsLambda = new lambda.Function(this, "ecstasklambda", {
            runtime: lambda.Runtime.NODEJS_10_X,
            handler: "index.handler",
            code: new lambda.AssetCode("lambda"),
            functionName: `${STACK_NAME}-ecs-task-change`
        });
        ecsLambda.addToRolePolicy(new aws_iam_1.PolicyStatement({
            actions: ["states:SendTaskSuccess"],
            resources: [loadtestsfn.stateMachineArn]
        }));
        const cwRule = new aws_events_1.Rule(this, "cw-rule", {
            description: "Rule that looks at ECS Task change state and triggers Lambda function",
            enabled: true,
            ruleName: "ECS-task-change-cdk",
            targets: []
        });
        new ssm.StringParameter(this, 'LoadTestS3Bucket', {
            // description: 'Some user-friendly description',
            parameterName: `/${BRANCH_NAME}/service/s3/loadtest/bucket`,
            stringValue: bucket.bucketName,
        });
        cwRule.addEventPattern({
            source: ['aws.ecs'],
            detailType: ["ECS Task State Change"],
            detail: {
                clusterArn: [cluster.clusterArn],
                lastStatus: ["STOPPED"]
            }
        });
        cwRule.addTarget(new targets.LambdaFunction(ecsLambda));
    }
}
exports.PerftestStackAirlineStack = PerftestStackAirlineStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVyZnRlc3Qtc3RhY2stYWlybGluZS1zdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInBlcmZ0ZXN0LXN0YWNrLWFpcmxpbmUtc3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxxQ0FBc0M7QUFDdEMsd0NBQXdDO0FBQ3hDLHdDQUF3QztBQUN4Qyx3Q0FBd0M7QUFDeEMsOENBQTJFO0FBQzNFLGtEQUFtRDtBQUNuRCwwREFBMkQ7QUFDM0QsZ0RBQTREO0FBQzVELGtFQUFzRjtBQUN0RixzQ0FBdUM7QUFDdkMsb0RBQTJDO0FBQzNDLDhDQUE4QztBQUM5Qyx1REFBdUQ7QUFDdkQsd0NBQXlDO0FBRXpDLE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDO0FBQzFDLE1BQU0sU0FBUyxHQUFHLEdBQUcsVUFBVSxlQUFlLENBQUM7QUFDL0MsTUFBTSxRQUFRLEdBQUcsR0FBRyxVQUFVLE1BQU0sQ0FBQztBQUNyQyxNQUFNLFVBQVUsR0FBRyxnQkFBZ0IsQ0FBQztBQUNwQyxNQUFNLE9BQU8sR0FBRyxDQUFDLENBQUE7QUFDakIsTUFBTSxxQkFBcUIsR0FBRyxHQUFHLFVBQVUsVUFBVSxDQUFBO0FBQ3JELE1BQU0sc0JBQXNCLEdBQUcsR0FBRyxVQUFVLFdBQVcsQ0FBQTtBQUN2RCxNQUFNLFdBQVcsR0FBRyxHQUFHLFVBQVUsVUFBVSxDQUFBO0FBQzNDLE1BQU0sd0JBQXdCLEdBQUcsR0FBRyxVQUFVLG1CQUFtQixDQUFBO0FBQ2pFLE1BQU0seUJBQXlCLEdBQUcsR0FBRyxVQUFVLG9CQUFvQixDQUFBO0FBQ25FLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQTtBQUN6QixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUE7QUFDaEIsTUFBTSxzQkFBc0IsR0FBRyxHQUFHLFVBQVUsb0JBQW9CLENBQUE7QUFDaEUsTUFBTSx1QkFBdUIsR0FBRyxHQUFHLFVBQVUscUJBQXFCLENBQUE7QUFDbEUsTUFBTSxr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LFVBQVUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUM7Z0JBQ2hDLFVBQVUsRUFBRSxDQUFDLFNBQVMsQ0FBQzthQUN4QjtTQUNGLENBQUMsQ0FBQTtRQUVGLE1BQU0sQ0FBQyxTQUFTLENBQUMsSUFBSSxPQUFPLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUE7SUFFekQsQ0FBQztDQUNGO0FBblNELDhEQW1TQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjZGsgPSByZXF1aXJlKCdAYXdzLWNkay9jb3JlJyk7XG5pbXBvcnQgZWMyID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLWVjMicpXG5pbXBvcnQgZWNzID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLWVjcycpXG5pbXBvcnQgZWNyID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLWVjcicpXG5pbXBvcnQgeyBSb2xlLCBTZXJ2aWNlUHJpbmNpcGFsLCBQb2xpY3lTdGF0ZW1lbnQgfSBmcm9tICdAYXdzLWNkay9hd3MtaWFtJztcbmltcG9ydCBzZm4gPSByZXF1aXJlKCdAYXdzLWNkay9hd3Mtc3RlcGZ1bmN0aW9ucycpO1xuaW1wb3J0IHRhc2tzID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLXN0ZXBmdW5jdGlvbnMtdGFza3MnKTtcbmltcG9ydCB7IExvZ0dyb3VwLCBSZXRlbnRpb25EYXlzIH0gZnJvbSAnQGF3cy1jZGsvYXdzLWxvZ3MnO1xuaW1wb3J0IHsgRGF0YSwgU2VydmljZUludGVncmF0aW9uUGF0dGVybiwgQ29udGV4dCB9IGZyb20gJ0Bhd3MtY2RrL2F3cy1zdGVwZnVuY3Rpb25zJztcbmltcG9ydCBzMyA9IHJlcXVpcmUoJ0Bhd3MtY2RrL2F3cy1zMycpO1xuaW1wb3J0IHsgUnVsZSB9IGZyb20gJ0Bhd3MtY2RrL2F3cy1ldmVudHMnO1xuaW1wb3J0IGxhbWJkYSA9IHJlcXVpcmUoJ0Bhd3MtY2RrL2F3cy1sYW1iZGEnKVxuaW1wb3J0IHRhcmdldHMgPSByZXF1aXJlKCdAYXdzLWNkay9hd3MtZXZlbnRzLXRhcmdldHMnKVxuaW1wb3J0IHNzbSA9IHJlcXVpcmUoJ0Bhd3MtY2RrL2F3cy1zc20nKTtcblxuY29uc3QgU1RBQ0tfTkFNRSA9IHByb2Nlc3MuZW52LlNUQUNLX05BTUU7XG5jb25zdCBST0xFX05BTUUgPSBgJHtTVEFDS19OQU1FfS1mYXJnYXRlLXJvbGVgO1xuY29uc3QgVlBDX05BTUUgPSBgJHtTVEFDS19OQU1FfS12cGNgO1xuY29uc3QgQ0lEUl9CTE9DSyA9IGAxOTguMTYyLjAuMC8yNGA7XG5jb25zdCBNQVhfQVpzID0gMlxuY29uc3QgRUNSX0dBVExJTkdfUkVQT19OQU1FID0gYCR7U1RBQ0tfTkFNRX0tZ2F0bGluZ2BcbmNvbnN0IEVDUl9NT0NLREFUQV9SRVBPX05BTUUgPSBgJHtTVEFDS19OQU1FfS1tb2NrZGF0YWBcbmNvbnN0IEVDU19DTFVTVEVSID0gYCR7U1RBQ0tfTkFNRX0tY2x1c3RlcmBcbmNvbnN0IEdBVExJTkdfRkFSR0FURV9UQVNLX0RFRiA9IGAke1NUQUNLX05BTUV9LWdhdGxpbmctdGFzay1kZWZgXG5jb25zdCBNT0NLREFUQV9GQVJHQVRFX1RBU0tfREVGID0gYCR7U1RBQ0tfTkFNRX0tbW9ja2RhdGEtdGFzay1kZWZgXG5jb25zdCBNRU1PUllfTElNSVQgPSAyMDQ4XG5jb25zdCBDUFUgPSAxMDI0XG5jb25zdCBHQVRMSU5HX0NPTlRBSU5FUl9OQU1FID0gYCR7U1RBQ0tfTkFNRX0tZ2F0bGluZy1jb250YWluZXJgXG5jb25zdCBNT0NLREFUQV9DT05UQUlORVJfTkFNRSA9IGAke1NUQUNLX05BTUV9LW1vY2tkYXRhLWNvbnRhaW5lcmBcbmNvbnN0IFNUQVRFX01BQ0hJTkVfTkFNRSA9IGBsb2FkdGVzdC0ke1NUQUNLX05BTUV9YFxuY29uc3QgUzNfQlVDS0VUX05BTUUgPSBgJHtTVEFDS19OQU1FfS1sb2FkdGVzdGBcbmNvbnN0IEJSQU5DSF9OQU1FID0gcHJvY2Vzcy5lbnYuQVdTX0JSQU5DSFxuY29uc3QgRk9MREVSUEFUSCA9IFwiLi9cIlxuXG5leHBvcnQgY2xhc3MgUGVyZnRlc3RTdGFja0FpcmxpbmVTdGFjayBleHRlbmRzIGNkay5TdGFjayB7XG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBjZGsuQXBwLCBpZDogc3RyaW5nLCBwcm9wcz86IGNkay5TdGFja1Byb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG5cbiAgICAvLyByZXRyaWV2aW5nIGFsbCBlbnZpcm9ubWVudCB2YXJpYWJsZXNcbiAgICBjb25zdCBBV1NfREVGQVVMVF9SRUdJT04gPSBwcm9jZXNzLmVudi5BV1NfREVGQVVMVF9SRUdJT05cbiAgICBjb25zdCBDT0dOSVRPX1VTRVJfUE9PTF9BUk4gPSBwcm9jZXNzLmVudi5DT0dOSVRPX1VTRVJfUE9PTF9BUk4gfHwgXCJub3RfZGVmaW5lZFwiXG4gICAgY29uc3QgVVNFUl9QT09MX0lEID0gcHJvY2Vzcy5lbnYuVVNFUl9QT09MX0lEIHx8IFwibm90X2RlZmluZWRcIlxuICAgIGNvbnN0IENPR05JVE9fQ0xJRU5UX0lEID0gcHJvY2Vzcy5lbnYuQ09HTklUT19DTElFTlRfSUQgfHwgXCJub3RfZGVmaW5lZFwiXG4gICAgY29uc3QgQ09HTklUT19VUkwgPSBgaHR0cHM6Ly9jb2duaXRvLWlkcC4ke0FXU19ERUZBVUxUX1JFR0lPTn0uYW1hem9uYXdzLmNvbS9gXG4gICAgY29uc3QgR1JBUEhRTF9VUkwgPSBwcm9jZXNzLmVudi5HUkFQSFFMX1VSTCB8fCBcIm5vdF9kZWZpbmVkXCJcbiAgICBjb25zdCBBUElfVVJMID0gcHJvY2Vzcy5lbnYuQVBJX1VSTCB8fCBcIm5vdF9kZWZpbmVkXCJcbiAgICBjb25zdCBHUkFQSFFMX0FQSV9JRCA9IHByb2Nlc3MuZW52LkdSQVBIUUxfQVBJX0lEIHx8IFwibm90X2RlZmluZWRcIlxuXG4gICAgY29uc3Qgcm9sZSA9IG5ldyBSb2xlKHRoaXMsIFJPTEVfTkFNRSwge1xuICAgICAgcm9sZU5hbWU6IFJPTEVfTkFNRSxcbiAgICAgIGFzc3VtZWRCeTogbmV3IFNlcnZpY2VQcmluY2lwYWwoJ2Vjcy10YXNrcy5hbWF6b25hd3MuY29tJylcbiAgICB9KVxuXG4gICAgY29uc3QgYnVja2V0ID0gbmV3IHMzLkJ1Y2tldCh0aGlzLCBcInMzYnVja2V0XCIsIHtcbiAgICAgIGJ1Y2tldE5hbWU6IFMzX0JVQ0tFVF9OQU1FXG4gICAgfSlcblxuICAgIHJvbGUuYWRkVG9Qb2xpY3kobmV3IFBvbGljeVN0YXRlbWVudCh7XG4gICAgICByZXNvdXJjZXM6IFtcbiAgICAgICAgYCR7YnVja2V0LmJ1Y2tldEFybn1gLFxuICAgICAgICBgJHtidWNrZXQuYnVja2V0QXJufS8qYFxuICAgICAgXSxcbiAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgJ3MzOlB1dE9iamVjdCcsXG4gICAgICAgICdzMzpHZXRPYmplY3RBY2wnLFxuICAgICAgICAnczM6R2V0T2JqZWN0JyxcbiAgICAgICAgJ3MzOkxpc3RCdWNrZXQnLFxuICAgICAgICAnczM6UHV0T2JqZWN0QWNsJyxcbiAgICAgICAgJ3MzOkRlbGV0ZU9iamVjdCdcbiAgICAgIF1cbiAgICB9KSlcblxuICAgIHJvbGUuYWRkVG9Qb2xpY3kobmV3IFBvbGljeVN0YXRlbWVudCh7XG4gICAgICByZXNvdXJjZXM6IFtgJHtDT0dOSVRPX1VTRVJfUE9PTF9BUk59YF0sXG4gICAgICBhY3Rpb25zOiBbXG4gICAgICAgICdjb2duaXRvLWlkcDpBZG1pbkluaXRpYXRlQXV0aCcsXG4gICAgICAgICdjb2duaXRvLWlkcDpBZG1pbkNyZWF0ZVVzZXInLFxuICAgICAgICAnY29nbml0by1pZHA6QWRtaW5TZXRVc2VyUGFzc3dvcmQnLFxuICAgICAgICAnY29nbml0by1pZHA6VXBkYXRlVXNlclBvb2xDbGllbnQnLFxuICAgICAgICAnY29nbml0by1pZHA6QWRtaW5EZWxldGVVc2VyJ1xuICAgICAgXVxuICAgIH0pKVxuXG4gICAgY29uc3QgdnBjID0gbmV3IGVjMi5WcGModGhpcywgVlBDX05BTUUsIHtcbiAgICAgIGNpZHI6IENJRFJfQkxPQ0ssXG4gICAgICBtYXhBenM6IE1BWF9BWnNcbiAgICB9KVxuXG5cbiAgICBjb25zdCBnYXRsaW5nUmVwb3NpdG9yeSA9IG5ldyBlY3IuUmVwb3NpdG9yeSh0aGlzLCBFQ1JfR0FUTElOR19SRVBPX05BTUUsIHtcbiAgICAgIHJlcG9zaXRvcnlOYW1lOiBFQ1JfR0FUTElOR19SRVBPX05BTUVcbiAgICB9KTtcblxuICAgIGNvbnN0IG1vY2tEYXRhUmVwb3NpdG9yeSA9IG5ldyBlY3IuUmVwb3NpdG9yeSh0aGlzLCBFQ1JfTU9DS0RBVEFfUkVQT19OQU1FLCB7XG4gICAgICByZXBvc2l0b3J5TmFtZTogRUNSX01PQ0tEQVRBX1JFUE9fTkFNRVxuICAgIH0pO1xuXG4gICAgY29uc3QgY2x1c3RlciA9IG5ldyBlY3MuQ2x1c3Rlcih0aGlzLCBFQ1NfQ0xVU1RFUiwge1xuICAgICAgdnBjOiB2cGMsXG4gICAgICBjbHVzdGVyTmFtZTogRUNTX0NMVVNURVJcbiAgICB9KTtcblxuICAgIGNvbnN0IGdhdGxpbmdUYXNrRGVmaW5pdGlvbiA9IG5ldyBlY3MuRmFyZ2F0ZVRhc2tEZWZpbml0aW9uKHRoaXMsIEdBVExJTkdfRkFSR0FURV9UQVNLX0RFRiwge1xuICAgICAgZmFtaWx5OiBHQVRMSU5HX0ZBUkdBVEVfVEFTS19ERUYsXG4gICAgICBleGVjdXRpb25Sb2xlOiByb2xlLFxuICAgICAgdGFza1JvbGU6IHJvbGUsXG4gICAgICBtZW1vcnlMaW1pdE1pQjogTUVNT1JZX0xJTUlULFxuICAgICAgY3B1OiBDUFVcbiAgICB9KTtcblxuICAgIGNvbnN0IG1vY2tEYXRhVGFza0RlZmluaXRpb24gPSBuZXcgZWNzLkZhcmdhdGVUYXNrRGVmaW5pdGlvbih0aGlzLCBNT0NLREFUQV9GQVJHQVRFX1RBU0tfREVGLCB7XG4gICAgICBmYW1pbHk6IE1PQ0tEQVRBX0ZBUkdBVEVfVEFTS19ERUYsXG4gICAgICBleGVjdXRpb25Sb2xlOiByb2xlLFxuICAgICAgdGFza1JvbGU6IHJvbGUsXG4gICAgICBtZW1vcnlMaW1pdE1pQjogTUVNT1JZX0xJTUlULFxuICAgICAgY3B1OiBDUFVcbiAgICB9KTtcblxuICAgIGNvbnN0IGdhdGxpbmdMb2dnaW5nID0gbmV3IGVjcy5Bd3NMb2dEcml2ZXIoe1xuICAgICAgbG9nR3JvdXA6IG5ldyBMb2dHcm91cCh0aGlzLCBHQVRMSU5HX0NPTlRBSU5FUl9OQU1FLCB7XG4gICAgICAgIGxvZ0dyb3VwTmFtZTogYC9hd3MvZWNzLyR7R0FUTElOR19DT05UQUlORVJfTkFNRX1gLFxuICAgICAgICByZXRlbnRpb246IFJldGVudGlvbkRheXMuT05FX1dFRUtcbiAgICAgIH0pLFxuICAgICAgc3RyZWFtUHJlZml4OiBcImdhdGxpbmdcIlxuICAgIH0pXG5cbiAgICBjb25zdCBtb2NrRGF0YWxvZ2dpbmcgPSBuZXcgZWNzLkF3c0xvZ0RyaXZlcih7XG4gICAgICBsb2dHcm91cDogbmV3IExvZ0dyb3VwKHRoaXMsIE1PQ0tEQVRBX0NPTlRBSU5FUl9OQU1FLCB7XG4gICAgICAgIGxvZ0dyb3VwTmFtZTogYC9hd3MvZWNzLyR7TU9DS0RBVEFfQ09OVEFJTkVSX05BTUV9YCxcbiAgICAgICAgcmV0ZW50aW9uOiBSZXRlbnRpb25EYXlzLk9ORV9XRUVLXG4gICAgICB9KSxcbiAgICAgIHN0cmVhbVByZWZpeDogXCJtb2NrZGF0YVwiXG4gICAgfSlcblxuICAgIC8vIENyZWF0ZSBjb250YWluZXIgZnJvbSBsb2NhbCBgRG9ja2VyZmlsZWAgZm9yIEdhdGxpbmdcbiAgICBjb25zdCBnYXRsaW5nQXBwQ29udGFpbmVyID0gZ2F0bGluZ1Rhc2tEZWZpbml0aW9uLmFkZENvbnRhaW5lcihHQVRMSU5HX0NPTlRBSU5FUl9OQU1FLCB7XG4gICAgICBpbWFnZTogZWNzLkNvbnRhaW5lckltYWdlLmZyb21FY3JSZXBvc2l0b3J5KGdhdGxpbmdSZXBvc2l0b3J5KSxcbiAgICAgIGxvZ2dpbmc6IGdhdGxpbmdMb2dnaW5nXG4gICAgfSk7XG5cbiAgICBjb25zdCB0b2tlbkNTViA9IHNzbS5TdHJpbmdQYXJhbWV0ZXIuZnJvbVN0cmluZ1BhcmFtZXRlckF0dHJpYnV0ZXModGhpcywgJ1RPS0VOX0NTVicsIHtcbiAgICAgIHBhcmFtZXRlck5hbWU6IGAvJHtCUkFOQ0hfTkFNRX0vc2VydmljZS9sb2FkdGVzdC9jc3YvdG9rZW5gLFxuICAgICAgdmVyc2lvbjogMVxuICAgIH0pO1xuXG4gICAgY29uc3QgdXNlckNTViA9IHNzbS5TdHJpbmdQYXJhbWV0ZXIuZnJvbVN0cmluZ1BhcmFtZXRlckF0dHJpYnV0ZXModGhpcywgJ1VTRVJfQ1NWJywge1xuICAgICAgcGFyYW1ldGVyTmFtZTogYC8ke0JSQU5DSF9OQU1FfS9zZXJ2aWNlL2xvYWR0ZXN0L2Nzdi91c2VyYCxcbiAgICAgIHZlcnNpb246IDFcbiAgICB9KTtcblxuICAgIGNvbnN0IGxvYWR0ZXN0QnVja2V0ID0gc3NtLlN0cmluZ1BhcmFtZXRlci5mcm9tU3RyaW5nUGFyYW1ldGVyQXR0cmlidXRlcyh0aGlzLCAnUzNfQlVDS0VUJywge1xuICAgICAgcGFyYW1ldGVyTmFtZTogYC8ke0JSQU5DSF9OQU1FfS9zZXJ2aWNlL3MzL2xvYWR0ZXN0L2J1Y2tldGAsXG4gICAgICB2ZXJzaW9uOiAxXG4gICAgfSk7XG5cbiAgICBjb25zdCB1c2VyUG9vbElEID0gc3NtLlN0cmluZ1BhcmFtZXRlci5mcm9tU3RyaW5nUGFyYW1ldGVyQXR0cmlidXRlcyh0aGlzLCAnVVNFUl9QT09MX0lEJywge1xuICAgICAgcGFyYW1ldGVyTmFtZTogYC8ke0JSQU5DSF9OQU1FfS9zZXJ2aWNlL2FtcGxpZnkvYXV0aC91c2VycG9vbC9pZGAsXG4gICAgICB2ZXJzaW9uOiAxXG4gICAgfSk7XG5cbiAgICBjb25zdCBjb2duaXRvQ2xpZW50SUQgPSBzc20uU3RyaW5nUGFyYW1ldGVyLmZyb21TdHJpbmdQYXJhbWV0ZXJBdHRyaWJ1dGVzKHRoaXMsICdDT0dOSVRPX0NMSUVOVF9JRCcsIHtcbiAgICAgIHBhcmFtZXRlck5hbWU6IGAvJHtCUkFOQ0hfTkFNRX0vc2VydmljZS9hbXBsaWZ5L2F1dGgvdXNlcnBvb2wvY2xpZW50SWRgLFxuICAgICAgdmVyc2lvbjogMVxuICAgIH0pO1xuXG4gICAgY29uc3QgbW9ja0RhdGFBcHBDb250YWluZXIgPSBtb2NrRGF0YVRhc2tEZWZpbml0aW9uLmFkZENvbnRhaW5lcihNT0NLREFUQV9DT05UQUlORVJfTkFNRSwge1xuICAgICAgaW1hZ2U6IGVjcy5Db250YWluZXJJbWFnZS5mcm9tRWNyUmVwb3NpdG9yeShtb2NrRGF0YVJlcG9zaXRvcnkpLFxuICAgICAgbG9nZ2luZzogbW9ja0RhdGFsb2dnaW5nLFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgXCJUT0tFTl9DU1ZcIjogIHRva2VuQ1NWLnN0cmluZ1ZhbHVlLFxuICAgICAgICBcIlVTRVJfQ1NWXCI6IHVzZXJDU1Yuc3RyaW5nVmFsdWUsXG4gICAgICAgIFwiQVdTX1JFR0lPTlwiOiBgJHtBV1NfREVGQVVMVF9SRUdJT059YCxcbiAgICAgICAgXCJTM19CVUNLRVRcIjogbG9hZHRlc3RCdWNrZXQuc3RyaW5nVmFsdWUsXG4gICAgICAgIFwiVVNFUl9QT09MX0lEXCI6IHVzZXJQb29sSUQuc3RyaW5nVmFsdWUsXG4gICAgICAgIC8vIFwiQ09HTklUT19DTElFTlRfSURcIjogY29nbml0b0NsaWVudElELnN0cmluZ1ZhbHVlLFxuICAgICAgICBcIkZPTERFUlBBVEhcIjogRk9MREVSUEFUSFxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gU3RlcCBmdW5jdGlvbiBmb3Igc2V0dGluZyB0aGUgbG9hZCB0ZXN0XG4gICAgY29uc3Qgc2V0dXBVc2VycyA9IG5ldyBzZm4uVGFzayh0aGlzLCBcIlNldHVwIFVzZXJzXCIsIHtcbiAgICAgIHRhc2s6IG5ldyB0YXNrcy5SdW5FY3NGYXJnYXRlVGFzayh7XG4gICAgICAgIGNsdXN0ZXIsXG4gICAgICAgIHRhc2tEZWZpbml0aW9uOiBtb2NrRGF0YVRhc2tEZWZpbml0aW9uLFxuICAgICAgICBhc3NpZ25QdWJsaWNJcDogdHJ1ZSxcbiAgICAgICAgY29udGFpbmVyT3ZlcnJpZGVzOiBbe1xuICAgICAgICAgIGNvbnRhaW5lck5hbWU6IG1vY2tEYXRhQXBwQ29udGFpbmVyLmNvbnRhaW5lck5hbWUsXG4gICAgICAgICAgY29tbWFuZDogRGF0YS5saXN0QXQoJyQuY29tbWFuZHMnKSxcbiAgICAgICAgICBlbnZpcm9ubWVudDogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBuYW1lOiAnc2V0dXAtdXNlcnMnLFxuICAgICAgICAgICAgICB2YWx1ZTogQ29udGV4dC50YXNrVG9rZW5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICBdXG4gICAgICAgIH1dLFxuICAgICAgICBpbnRlZ3JhdGlvblBhdHRlcm46IFNlcnZpY2VJbnRlZ3JhdGlvblBhdHRlcm4uV0FJVF9GT1JfVEFTS19UT0tFTlxuICAgICAgfSlcbiAgICB9KVxuXG4gICAgY29uc3QgbG9hZEZsaWdodHMgPSBuZXcgc2ZuLlRhc2sodGhpcywgXCJMb2FkIEZsaWdodHNcIiwge1xuICAgICAgdGFzazogbmV3IHRhc2tzLlJ1bkVjc0ZhcmdhdGVUYXNrKHtcbiAgICAgICAgY2x1c3RlcixcbiAgICAgICAgdGFza0RlZmluaXRpb246IG1vY2tEYXRhVGFza0RlZmluaXRpb24sXG4gICAgICAgIGFzc2lnblB1YmxpY0lwOiB0cnVlLFxuICAgICAgICBjb250YWluZXJPdmVycmlkZXM6IFt7XG4gICAgICAgICAgY29udGFpbmVyTmFtZTogbW9ja0RhdGFBcHBDb250YWluZXIuY29udGFpbmVyTmFtZSxcbiAgICAgICAgICBjb21tYW5kOiBEYXRhLmxpc3RBdCgnJC5jb21tYW5kcycpLFxuICAgICAgICAgIGVudmlyb25tZW50OiBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIG5hbWU6ICdsb2FkLWZsaWdodHMnLFxuICAgICAgICAgICAgICB2YWx1ZTogQ29udGV4dC50YXNrVG9rZW5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICBdXG4gICAgICAgIH1dLFxuICAgICAgICBpbnRlZ3JhdGlvblBhdHRlcm46IFNlcnZpY2VJbnRlZ3JhdGlvblBhdHRlcm4uV0FJVF9GT1JfVEFTS19UT0tFTlxuICAgICAgfSlcbiAgICB9KVxuXG4gICAgY29uc3QgcnVuR2F0bGluZyA9IG5ldyBzZm4uVGFzayh0aGlzLCBcIlJ1biBHYXRsaW5nXCIsIHtcbiAgICAgIHRhc2s6IG5ldyB0YXNrcy5SdW5FY3NGYXJnYXRlVGFzayh7XG4gICAgICAgIGNsdXN0ZXIsXG4gICAgICAgIHRhc2tEZWZpbml0aW9uOiBnYXRsaW5nVGFza0RlZmluaXRpb24sXG4gICAgICAgIGFzc2lnblB1YmxpY0lwOiB0cnVlLFxuICAgICAgICBjb250YWluZXJPdmVycmlkZXM6IFt7XG4gICAgICAgICAgY29udGFpbmVyTmFtZTogZ2F0bGluZ0FwcENvbnRhaW5lci5jb250YWluZXJOYW1lLFxuICAgICAgICAgIGNvbW1hbmQ6IERhdGEubGlzdEF0KCckLmNvbW1hbmRzJyksXG4gICAgICAgICAgZW52aXJvbm1lbnQ6IFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgbmFtZTogJ3J1bi1nYXRsaW5nJyxcbiAgICAgICAgICAgICAgdmFsdWU6IENvbnRleHQudGFza1Rva2VuXG4gICAgICAgICAgICB9XG4gICAgICAgICAgXVxuICAgICAgICB9XSxcbiAgICAgICAgaW50ZWdyYXRpb25QYXR0ZXJuOiBTZXJ2aWNlSW50ZWdyYXRpb25QYXR0ZXJuLldBSVRfRk9SX1RBU0tfVE9LRU5cbiAgICAgIH0pXG4gICAgfSlcblxuICAgIGNvbnN0IGNvbnNvbGlkYXRlUmVwb3J0ID0gbmV3IHNmbi5UYXNrKHRoaXMsIFwiQ29uc29saWRhdGUgUmVwb3J0XCIsIHtcbiAgICAgIHRhc2s6IG5ldyB0YXNrcy5SdW5FY3NGYXJnYXRlVGFzayh7XG4gICAgICAgIGNsdXN0ZXIsXG4gICAgICAgIHRhc2tEZWZpbml0aW9uOiBnYXRsaW5nVGFza0RlZmluaXRpb24sXG4gICAgICAgIGFzc2lnblB1YmxpY0lwOiB0cnVlLFxuICAgICAgICBjb250YWluZXJPdmVycmlkZXM6IFt7XG4gICAgICAgICAgY29udGFpbmVyTmFtZTogZ2F0bGluZ0FwcENvbnRhaW5lci5jb250YWluZXJOYW1lLFxuICAgICAgICAgIGNvbW1hbmQ6IERhdGEubGlzdEF0KCckLmNvbW1hbmRzJyksXG4gICAgICAgICAgZW52aXJvbm1lbnQ6IFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgbmFtZTogJ2NvbnNvbGlkYXRlLXJlcG9ydCcsXG4gICAgICAgICAgICAgIHZhbHVlOiBDb250ZXh0LnRhc2tUb2tlblxuICAgICAgICAgICAgfVxuICAgICAgICAgIF1cbiAgICAgICAgfV0sXG4gICAgICAgIGludGVncmF0aW9uUGF0dGVybjogU2VydmljZUludGVncmF0aW9uUGF0dGVybi5XQUlUX0ZPUl9UQVNLX1RPS0VOXG4gICAgICB9KVxuICAgIH0pXG5cbiAgICBjb25zdCBjbGVhblVwID0gbmV3IHNmbi5UYXNrKHRoaXMsIFwiQ2xlYW4gVXBcIiwge1xuICAgICAgdGFzazogbmV3IHRhc2tzLlJ1bkVjc0ZhcmdhdGVUYXNrKHtcbiAgICAgICAgY2x1c3RlcixcbiAgICAgICAgdGFza0RlZmluaXRpb246IG1vY2tEYXRhVGFza0RlZmluaXRpb24sXG4gICAgICAgIGFzc2lnblB1YmxpY0lwOiB0cnVlLFxuICAgICAgICBjb250YWluZXJPdmVycmlkZXM6IFt7XG4gICAgICAgICAgY29udGFpbmVyTmFtZTogbW9ja0RhdGFBcHBDb250YWluZXIuY29udGFpbmVyTmFtZSxcbiAgICAgICAgICBjb21tYW5kOiBEYXRhLmxpc3RBdCgnJC5jb21tYW5kcycpLFxuICAgICAgICAgIGVudmlyb25tZW50OiBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIG5hbWU6ICdjbGVhbi11cCcsXG4gICAgICAgICAgICAgIHZhbHVlOiBDb250ZXh0LnRhc2tUb2tlblxuICAgICAgICAgICAgfVxuICAgICAgICAgIF1cbiAgICAgICAgfV0sXG4gICAgICAgIGludGVncmF0aW9uUGF0dGVybjogU2VydmljZUludGVncmF0aW9uUGF0dGVybi5XQUlUX0ZPUl9UQVNLX1RPS0VOXG4gICAgICB9KVxuICAgIH0pXG5cbiAgICBjb25zdCBzdGVwZnVuY0RlZmluaXRpb24gPSBzZXR1cFVzZXJzXG4gICAgICAubmV4dChsb2FkRmxpZ2h0cylcbiAgICAgIC5uZXh0KHJ1bkdhdGxpbmcpXG4gICAgICAubmV4dChjb25zb2xpZGF0ZVJlcG9ydClcbiAgICAgIC5uZXh0KGNsZWFuVXApXG5cbiAgICBjb25zdCBsb2FkdGVzdHNmbiA9IG5ldyBzZm4uU3RhdGVNYWNoaW5lKHRoaXMsIFNUQVRFX01BQ0hJTkVfTkFNRSwge1xuICAgICAgc3RhdGVNYWNoaW5lTmFtZTogU1RBVEVfTUFDSElORV9OQU1FLFxuICAgICAgZGVmaW5pdGlvbjogc3RlcGZ1bmNEZWZpbml0aW9uXG4gICAgfSlcblxuICAgIGNvbnN0IGVjc0xhbWJkYSA9IG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgXCJlY3N0YXNrbGFtYmRhXCIsIHtcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xMF9YLFxuICAgICAgaGFuZGxlcjogXCJpbmRleC5oYW5kbGVyXCIsXG4gICAgICBjb2RlOiBuZXcgbGFtYmRhLkFzc2V0Q29kZShcImxhbWJkYVwiKSxcbiAgICAgIGZ1bmN0aW9uTmFtZTogYCR7U1RBQ0tfTkFNRX0tZWNzLXRhc2stY2hhbmdlYFxuICAgIH0pXG5cbiAgICBlY3NMYW1iZGEuYWRkVG9Sb2xlUG9saWN5KG5ldyBQb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgYWN0aW9uczogW1wic3RhdGVzOlNlbmRUYXNrU3VjY2Vzc1wiXSxcbiAgICAgIHJlc291cmNlczogW2xvYWR0ZXN0c2ZuLnN0YXRlTWFjaGluZUFybl1cbiAgICB9KSlcblxuICAgIGNvbnN0IGN3UnVsZSA9IG5ldyBSdWxlKHRoaXMsIFwiY3ctcnVsZVwiLCB7XG4gICAgICBkZXNjcmlwdGlvbjogXCJSdWxlIHRoYXQgbG9va3MgYXQgRUNTIFRhc2sgY2hhbmdlIHN0YXRlIGFuZCB0cmlnZ2VycyBMYW1iZGEgZnVuY3Rpb25cIixcbiAgICAgIGVuYWJsZWQ6IHRydWUsXG4gICAgICBydWxlTmFtZTogXCJFQ1MtdGFzay1jaGFuZ2UtY2RrXCIsXG4gICAgICB0YXJnZXRzOiBbXG4gICAgICBdXG4gICAgfSlcblxuICAgIG5ldyBzc20uU3RyaW5nUGFyYW1ldGVyKHRoaXMsICdMb2FkVGVzdFMzQnVja2V0Jywge1xuICAgICAgLy8gZGVzY3JpcHRpb246ICdTb21lIHVzZXItZnJpZW5kbHkgZGVzY3JpcHRpb24nLFxuICAgICAgcGFyYW1ldGVyTmFtZTogYC8ke0JSQU5DSF9OQU1FfS9zZXJ2aWNlL3MzL2xvYWR0ZXN0L2J1Y2tldGAsXG4gICAgICBzdHJpbmdWYWx1ZTogYnVja2V0LmJ1Y2tldE5hbWUsXG4gICAgICAvLyBhbGxvd2VkUGF0dGVybjogJy4qJyxcbiAgICB9KTtcblxuICAgIGN3UnVsZS5hZGRFdmVudFBhdHRlcm4oe1xuICAgICAgc291cmNlOiBbJ2F3cy5lY3MnXSxcbiAgICAgIGRldGFpbFR5cGU6IFtcIkVDUyBUYXNrIFN0YXRlIENoYW5nZVwiXSxcbiAgICAgIGRldGFpbDoge1xuICAgICAgICBjbHVzdGVyQXJuOiBbY2x1c3Rlci5jbHVzdGVyQXJuXSxcbiAgICAgICAgbGFzdFN0YXR1czogW1wiU1RPUFBFRFwiXVxuICAgICAgfVxuICAgIH0pXG5cbiAgICBjd1J1bGUuYWRkVGFyZ2V0KG5ldyB0YXJnZXRzLkxhbWJkYUZ1bmN0aW9uKGVjc0xhbWJkYSkpXG5cbiAgfVxufVxuIl19